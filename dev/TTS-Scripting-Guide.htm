<html xmlns="http://www.w3.org/TR/REC-html40">

<body>

<p><a name="content"></a><a name="header"></a><span><b>Table of Contents</b><span><br>
1. </span></span><a href="#repo-architecture-map">Repo Architecture Map � King�s Dilemma &amp; VTM
Heritage Modules</a><span><span><br>
- Structure Overview<br>
- Key Scripts &amp; Components (Inventory Table)<br>
- Startup Flow &amp; State Persistence Narrative<br>
2. </span></span><a href="#ui-hud-handbook">UI/HUD Handbook �
Building &amp; Using Interactive Elements</a><span><span><br>
- UI Structure and Event Wiring (with Repo Examples)<br>
- Dynamic Updates &amp; Feedback Patterns<br>
- Minimal UI Examples (HUD panel, modal dialog, role-based UI)<br>
3. </span></span><a href="#immersion-controls">Immersion
Controls � Lighting, Ambiance &amp; Sound</a><span><span><br>
- Existing Module Features (Lighting effects in repo)<br>
- Scripting Guide: Controlling Lighting &amp; Sound<br>
- �Scene Preset� System for VTM (design ideas)<br>
4. </span></span><a href="#bundling-and-code-reuse">Bundling &amp; Code Reuse Workflow</a><span><span><br>
- How the Repo Handles Code Organization (Analysis)<br>
- Modern Best-Practices for Modular TTS Scripting<br>
- Template Process for New Objects (avoiding duplication)<br>
5. </span></span><a href="#utility-functions-index">Utility Functions Index &amp; Reusable Toolkit</a><span><span><br>
- Categorized Useful Functions from the Repo<br>
- Extraction Considerations and Dependencies<br>
- Proposed </span>lib/<span> Layout for New Module<br>
6. </span></span><a href="#new-vtm5e-module-blueprint">Blueprint: New VTM5E Module Design</a><span><span><br>
- Storyteller Control Surface (GM Tools)<br>
- Player Experience &amp; UI Panels<br>
- Hidden Info Mechanics and Safety Tools<br>
- MVP Feature Set and Roadmap<br>
7. </span></span><a href="#do-this-next-quickstart">Quickstart � Next Steps</a><span><span><br>
- Checklist to Initialize a Fresh Module Skeleton<br>
- First 3 Features to Implement (Pipeline Validation)<br>
- Common Pitfalls &amp; Troubleshooting Tips</span></span></p>

<p>&lt;a
name=&quot;repo-architecture-map&quot;&gt;&lt;/a&gt;</p>

<h2><a name="X256996168e565a4a474800fb7eb026f3b21af2b"></a></h2>

<h3><a name="structure-overview"></a></h3>

<p><span><span><span><b>Observed in repo:</b><span> The
repository is organized into two main modules � one for <i>The
King�s Dilemma</i> and one for <i>Vampire: The Masquerade � Heritage</i>. Each
module has its own folder structure and global script entry point. For King�s
Dilemma, the global script is </span></span></span></span>kingsdilemma.ttslua at
the repo root, which uses a modular require() system to
include a suite of files under kingsdilemma/<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L26-L34">[1]</a>. The VTM Heritage module
resides in the VTMH/ directory, with
VTMH/heritage.ttslua as
its global script<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L1-L9">[2]</a>. Both modules share a
common lib/ folder for generic
utilities (e.g. lib/utilities.ttslua).
This suggests an external workflow where code is segmented by
feature and assembled via a custom require mechanism (likely injected by the VS
Code extension, given the require(&quot;vscode/console&quot;) debug includes<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L23-L31">[3]</a><span><span><span><span>). Each module contains
subfolders for <b>core logic</b>, <b>UI definitions</b>, <b>object scripts</b>,
<b>zone scripts</b>, and <b>constants/assets</b>, as detailed below.</span></span></span></span></p>

<p><span><span><span><b>From official
docs:</b><span> Tabletop Simulator
normally does not support multi-file requires in native Lua, so this structure
implies a development-time include system. TTS�s <i>External Editor</i> mode
(and community tools) allow splitting code into files which are then combined
or synced to the game</span></span></span></span><a href="https://api.tabletopsimulator.com/lighting/#:~:text=Lighting%2C%20a%20static%20global%20class%2C,Lighting.apply">[4]</a><a href="https://api.tabletopsimulator.com/lighting/#:~:text=Lighting.light_intensity%20%3D%202%20Lighting.setLightColor%28,Lighting.apply">[5]</a>. In the repo, require(&quot;...&quot;)
calls are used as placeholders to pull in those files before uploading
to TTS. This keeps each component�s logic separate and avoids one giant script
file during development.</p>

<p><span><span><span><span>Below is an
<b>inventory of key scripts/components</b> in each module,
with their file paths, purposes, notable functions/events, and relationships:</span></span></span></span>
</p>

<h4><a name="kings-dilemma-module-key-scripts"></a></h4>

<table class="table" border=0>
<thead>
<tr>
<td>
<p><span><span><span><span><b>File
(Path)</b></span></span></span></span></p>
</td>
<span></span>
<td>
<p><span><span><span><span><b>Purpose</b> / Description</span></span></span></span></p>
</td>
<span></span>
<td>
<p><span><span><span><span><b>Key Functions &amp;
Events</b></span></span></span></span></p>
</td>
<span></span>
<td>
<p><span><span><span><span><b>Dependencies /
Uses</b></span></span></span></span></p>
</td>
<span></span>
</tr>
</thead>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma.ttslua</b></span> (root)</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Global
script entry:</i> Initializes module, imports
sub-modules.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Requires
core libraries (U, C, etc.)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L26-L34">[1]</a>; defines global tables (e.g.
gameState<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L35-L41">[6]</a>); may define stub events (empty
onExternalCommand in snippet) and pass
control to sub-modules.</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Uses <b>lib.utilities</b>
as U, <b>kingsdilemma.lib.constants</b> (C), <b>.lib.objects</b> (O), <b>.core.state</b>
(S), <b>.core.lighting</b> (L), <b>.core.voting</b> (V), etc.</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L26-L34">[1]</a><span><span><span><span><span>. Loads <b>kingsdilemma.hud</b>,
<b>.listeners</b>, <b>.debug</b>
which register event handlers.</span></span></span></span></span></p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma/listeners.ttslua</b></span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Global
event listeners:</i> Implements game-wide event
callbacks.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><b>onLoad</b> � initializes game state via </span></span></span></span>S.InitializeGameState and shows UI<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L48-L56">[7]</a><span><span><span><span><span>; <b>onSave</b> � serializes
state via </span></span></span></span></span>JSON.encode(S.getGameState())<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L52-L55">[8]</a><span><span><span><span><span>; intercepts events:
<b>onPlayerTurnStart</b> (adjust camera)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L64-L67">[9]</a><span><span><span><span><span>, <b>onPlayerAction</b> (custom
delete behavior)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L69-L77">[10]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L78-L86">[11]</a><span><span><span><span><span>, <b>onObjectDrop</b> (complex
logic for secret agendas &amp; tokens)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L100-L108">[12]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L109-L117">[13]</a>,
etc.</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Uses core
modules: state S, player helper P, lighting L, messaging MSG, director DIR,
object utils OU, etc.<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L2-L10">[14]</a><span><span><span><span><span>. Relies on <b>U</b> (utilities)
for common functions (filtering,
tagging)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L69-L77">[10]</a><span><span><span><span><span> and calls into <b>DIR</b> and
<b>L</b> to advance phases or set
lights</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L115-L123">[15]</a>. Shares
gameState data via S module.</p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma/hud.ttslua</b></span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>User
Interface logic:</i> Builds and updates on-screen HUD
and handles UI events.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Defines
UI event handler functions: <b>HUD_Click</b> (central onClick dispatcher) to
route button presses</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L254-L263">[16]</a> (e.g.
initSession -&gt; DIR.InitSession()<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L262-L270">[17]</a><span><span><span><span><span>, toggles, debug buttons, etc.),
<b>HUD_HoverOn / HUD_HoverOff</b> to
handle tooltip highlighting</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L316-L324">[18]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L327-L336">[19]</a>. Contains helpers for dynamic
UI: e.g. toggleXmlElement() to show/hide panels<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L181-L190">[20]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L192-L200">[21]</a>. Initializes debug �test
function� buttons on load<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L163-L172">[22]</a>.</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Imports
core libs (DIR, P, O, C, U, S, etc.)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L2-L10">[23]</a><span><span><span><span><span>. Uses <b>UI API</b> calls
(</span></span></span></span></span>UI.setAttribute, UI.show, etc.) to modify XML elements at
runtime<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L256-L265">[24]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L280-L289">[25]</a>. Tied to an XML file (see
kdxml/admin.xml) defining the static
layout of admin controls (visibility Host only)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L23-L31">[26]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L46-L54">[27]</a><span><span><span><span><span>. Depends on <b>MSG</b> for
messaging players (e.g. splash text) and <b>L</b>
for lighting adjustments on toggles</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L186-L194">[28]</a>.</p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma/core/state.ttslua</b></span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Game
State management:</i> Stores and retrieves persistent
game data (phases, tokens, etc.).</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>(Inferred)
likely provides InitializeGameState(save_data) (called
onLoad<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L48-L56">[7]</a>) to load saved state or set
defaults, getGameState() and setGameState() to interface with the
global gameState. Possibly defines state
structure (phases, players, lights).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Used by
<b>listeners.onLoad/onSave</b>
for persistence</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L48-L56">[7]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L52-L55">[8]</a>. Other modules call S to check
game phase (S.isInPhase, S.isInMode) and to update state (e.g. S.setStateVal in lighting<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L644-L651">[29]</a><span><span><span><span><span>). Relies on
<b>lib.constants</b> for keys and initial values.</span></span></span></span></span></p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma/core/lighting.ttslua</b></span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Dynamic
lighting system:</i> Controls scene lights (spotlights,
arrows) and environment.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Defines
data for each named light and multiple modes (e.g.
off/ambient/momentumUp)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L10-L18">[30]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L22-L31">[31]</a><span><span><span><span><span>. Key functions:
<b>L.SetLightMode(name, mode, player?)</b> �
smoothly transitions a light object to a preset mode (color, intensity,
etc.)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L676-L684">[32]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L686-L695">[33]</a> using interpolation (via
U.Lerp and U.RunSequence)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L682-L690">[34]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L691-L700">[35]</a><span><span><span><span><span>;
<b>L.ResetLights/PrimeLights</b> � turn off or pre-orient lights
for next sequence</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L722-L730">[36]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L734-L742">[37]</a><span><span><span><span><span>; <b>L.ShowArrows/HideArrows</b>
� visual indicator using light
asset�s effects (plays a looping arrow effect and highlights the
light)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L540-L549">[38]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L551-L559">[39]</a>.</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Uses <b>TTS
Light objects</b> (by name/GUID) and their <b>LightComponent</b> via
</span></span></span></span></span>getComponent (abstracted as local getComp() � not shown, but implied in use
of .get(&quot;enabled&quot;) etc.<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L559-L567">[40]</a><span><span><span><span><span>). Heavy use of <b>U</b> for
math, waiting, and validations (e.g. </span></span></span></span></span>U.Val assertions, U.waitUntil for async)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L619-L628">[41]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L715-L720">[42]</a>. Stores light state to S (so
settings persist on save)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L643-L651">[43]</a><span><span><span><span><span>. Relies on <b>C</b> for color
constants and predefined positions,
and on <b>Player</b> data for player-specific spotlights.</span></span></span></span></span></p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma/core/voting.ttslua</b></span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Voting
mechanics:</i> Manages turn order and voting outcomes
for dilemmas.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>(Inferred
from usage) likely tracks whose turn it is to vote, collects votes, and
resolves results. Possibly defines V.EndTurn() (called on UI �Transfer�
button)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L110-L114">[44]</a> to conclude a voting turn, and
coordinates with Director for phase
changes. Might also handle tallying power tokens on votes and manipulating
game state accordingly.</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Interfaces
with <b>core.director</b> (the game flow orchestrator) and <b>core.players</b>
(e.g. to set camera or leader). UI callbacks in HUD (e.g. </span></span></span></span></span>advanceGamePhase -&gt; DIR.ADVANCE()<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L264-L271">[45]</a><span><span><span><span><span>) suggest Director drives phase
advancement, possibly informed by
Voting�s state. Also likely uses <b>lighting</b> (e.g. to flash outcome
lights) and <b>messaging</b> to announce results.</span></span></span></span></span></p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma/core/director.ttslua</b></span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Game
flow director:</i> Coordinates high-level phase
transitions and special events (envelope openings, sticker placements,
etc.).</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Likely
provides functions to initialize sessions (DIR.InitPreflight, InitSession � tied to UI buttons<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L260-L268">[46]</a>), advance game phases
(ADVANCE()), reset or setup the table (DIR.RESET() called from UI<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L272-L280">[47]</a>), manage Chronicle type
(SetChronicleType) and handle end-of-game
sequences. In listeners, DIR.EndSecretAgendas() is called when
secret agenda selection finishes<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L114-L121">[48]</a>. Director probably uses a state
machine (game phases/modes stored in
S).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Uses <b>state
S</b> to know current phase/mode and update it (phase displays updated via
</span></span></span></span></span>Global.call(&quot;UpdatePhaseDisplay&quot;) after
resets<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L282-L290">[49]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L296-L304">[50]</a><span><span><span><span><span>). Coordinates with
<b>Voting</b> for turn order and with <b>Messaging</b>
for player prompts (e.g. </span></span></span></span></span>MSG.SplashQuery calls in HUD test funcs
mimic Director prompts<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L78-L86">[51]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L90-L98">[52]</a><span><span><span><span><span>). Also triggers <b>lighting</b>
changes at key moments (e.g.
spotlight the current player or highlight tokens).</span></span></span></span></span></p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma/lib/constants.ttslua</b></span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Constants
and configuration:</i> Defines static data like
positions, colors, tags, and scenario parameters.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Likely
contains tables for coordinates of important spots (e.g. C.Spots.Board.StabilityToken.* used in
listeners<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L156-L164">[53]</a>), lists of Houses
(C.Houses used for random house assignment
in UI sim click<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L208-L216">[54]</a>), mapping of resource names,
camera presets (C.CameraAngles for different views used
in P.SetCamera). Probably also includes tag name constants (like
&quot;SecretAgenda&quot;, &quot;PowerToken&quot;).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Pure data
� referenced by many modules: <b>listeners</b> (for movement
boundaries</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L156-L164">[53]</a><span><span><span><span><span>), <b>players</b> (for camera
presets), <b>lighting</b> (for resource
light identification and color values</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L10-L18">[30]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L50-L59">[55]</a>), etc. No external
dependencies; meant to be read-only.</p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>kingsdilemma/objects/houseCard.ttslua</b></span>
(and similar object scripts)</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Object-level
scripts:</i> Attached to specific game objects on the
table (e.g. House cards, Chronicle cards, Screens). Handle interactions
localized to that object.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>For
example, a House card might implement <b>onPickUp</b> or <b>onDrop</b> events
to, say, lock it during certain phases or to trigger an update when placed
somewhere. It might also have a function to update its UI (e.g. display house
name or emblem). The House screens (</span></span></span></span></span>houseScreen.ttslua) likely manage
showing/hiding a player's information panel (possibly via UI.setAttributes on elements visible only
to that player). These scripts may also respond to calls from global (ex:
P.GetPlayerScreen(player).call(&quot;Activate&quot;) is invoked in Heritage
module<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L240-L248">[56]</a>, showing cross-module
technique).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>These
object scripts often <b>call Global functions</b> or use global singletons
rather than duplicate logic. <i>Example:</i> Heritage calls
</span></span></span></span></span>P.GetPlayerScreen().call(&quot;UpdateXMLTable&quot;)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L240-L248">[56]</a> � implying the screen object
script has an <span><span><span><span>UpdateXMLTable<span> function to refresh its UI
from global data. This pattern avoids duplicating code across identical
objects � the global provides data, each object script just updates its own
display. Dependencies: Usually small, but they use <b>U</b> utilities and
reference <b>G</b> (GUIDs) or <b>C</b> for any constants. They often interact
with <b>Global UI</b> (via </span></span></span></span><span><span><span>UI<span> if they have custom UI on the object)
and <b>Zones</b> (if they detect being placed in a zone).</span></span></span></span></span></p>
</td>
<span></span>
</tr>
</table>

<p><span><span><span><span><i>Table 1:
Key scripts in King�s Dilemma module (structure and
responsibilities).</i></span></span></span></span></p>

<h4><a name="vtm-heritage-vtmh-module-key-scripts"></a></h4>

<table class="table" border=0>
<thead>
<tr>
<td>
<p><span><span><span><span><b>File
(Path)</b></span></span></span></span></p>
</td>
<span></span>
<td>
<p><span><span><span><span><b>Purpose</b> / Description</span></span></span></span></p>
</td>
<span></span>
<td>
<p><span><span><span><span><b>Key Functions &amp;
Events</b></span></span></span></span></p>
</td>
<span></span>
<td>
<p><span><span><span><span><b>Dependencies /
Uses</b></span></span></span></span></p>
</td>
<span></span>
</tr>
</thead>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>VTMH/heritage.ttslua</b></span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Global
script entry:</i> Initializes the Heritage module and
links global events to core logic.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Sets
up event handlers by assigning global callbacks to module functions (e.g.
onLoad = M.onLoad, onPlayerTurn = M.onPlayerTurn, etc.<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L44-L52">[57]</a>). Defines a global
gameState table<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L10-L18">[58]</a> for persistent data.
Contains test hooks (HUD_testFunc1/2/3) for dev
shortcuts (e.g. toggling setup or resetting battlegrounds)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L13-L21">[59]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L22-L30">[60]</a>. Implements utility
toggles: ActivateZones()/DeactivateZones() to
globally enable/disable zone triggers by (un)assigning onObjectEnterZone<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L33-L41">[61]</a>. The onSave event returns a
JSON of gameState<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L50-L53">[62]</a> (note: Heritage uses a
single gameState table for save, unlike KD�s
structured S).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Requires
<b>core.main</b> as M, <b>lib.utilities</b> (U), <b>lib.constants</b> (C), <b>core.state</b>
(S), <b>lib.guids</b> (G), <b>core.zones</b> (Z), <b>core.fourthRow</b>
(F)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L1-L9">[2]</a>. By mapping TTS events to
M�s functions<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L44-L52">[57]</a>, it delegates runtime logic
to core/main.ttslua. The test HUD functions
call into M or objects via GUID (e.g. getObjectFromGUID(G.battlegrounds.i).call(&quot;Initialize&quot;) to init a
battleground mini-game)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L16-L25">[63]</a><span><span><span><span><span>. Depends on <b>G</b> for
GUID references and uses <b>UI</b> via HUD_
functions for debug toggles (e.g. HUD_toggleZonesActive toggles zone
visibility/UI text using Z module)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L79-L87">[64]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L88-L93">[65]</a>.</p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>VTMH/core/main.ttslua</b></span> (M)</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Main
game logic:</i> Orchestrates game setup, phase
progression, and overall rules for VTM Heritage.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><b>M.onLoad(save_state)</b> � Loads saved state (decodes JSON into
</span></span></span></span>S.setGameState)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L302-L310">[66]</a>, initializes key objects
(fetches token bags by GUID)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L311-L319">[67]</a>, registers global hotkeys
for spawning tokens at pointer
(Power/Infamy/etc)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L316-L325">[68]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L332-L340">[69]</a>, and runs a sequence of
setup steps via U.sequence<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L350-L359">[70]</a>. That sequence calls:
M.initializeGlobals() (finds decks and
objects, caches positions)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L144-L153">[71]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L156-L161">[72]</a>,
invisObjects() to hide certain objects
from players<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L79-L87">[73]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L89-L95">[74]</a> (e.g. legacy components not
in use), M.syncState() and M.syncPhase() to update any global UI or
state-dependent visuals, and activates zone triggers via Z.onLoad and Z.activateZones()<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L354-L362">[75]</a>. Also highlights certain
boards (M.highlightBattlegrounds) after setup<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L372-L380">[76]</a><span><span><span><span><span>. <b>M.onPlayerTurn</b> �
called when turn changes, used here to
advance turn counters or auto-advance turns outside play
phase</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L370-L378">[77]</a> (if not in Play phase, it
disables the turn system)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L376-L384">[78]</a><span><span><span><span><span>. <b>M.onPlayerAction</b> �
custom deletion logic for Heritage
tokens/cards: e.g. deleting a Power or Infamy token actually destroys it
(preventing infinite bag tokens)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L384-L393">[79]</a>; deleting certain tiles
moves them to discard piles instead of
removal (Assets to a storage, Clan tokens repositioned to default spots,
Character cards to discard, etc.)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L389-L398">[80]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L413-L421">[81]</a>. It returns false for
handled cases to override default delete<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L430-L433">[82]</a><span><span><span><span><span>. <b>M.onPlayerConnect</b> �
auto-promotes players (since it�s a
trusted group)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L440-L448">[83]</a><span><span><span><span><span>.
<b>M.tryObjectEnterContainer</b> � governs stack/container
behavior: allows or disallows combining cards based on tags (e.g. ClanScheme
cards can stack only with like, prevents mixing unrelated
cards)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L444-L452">[84]</a>. Beyond event handlers, M
contains many gameflow functions triggered
by UI: e.g. M.gameSETUP(), gameINIT(), gameSTART()... gameEND() for each phase of a
campaign<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L70-L78">[85]</a>, which likely manipulate S
(phase tracking) and call into Z or other
modules to adjust the board. It also has utility functions like
M.getRandomCard(deck) to draw random card<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L120-L129">[86]</a>,
M.translateObj(obj, translation) to nudge
objects<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L136-L144">[87]</a>, and specialized logic for
Heritage�s legacy mechanics (trait and
sticker management, as seen with M.showUpdatedTraits() and M.showStickerUnlocks() tied to HUD
buttons<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L115-L124">[88]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L122-L129">[89]</a>).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Imports
numerous helpers: <b>S</b> (state management), <b>G</b> (GUID references for
objects/zones), <b>C</b> (constant tables like clan names, etc.), <b>Z</b>
(zones logic), <b>U</b> (utilities)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L1-L9">[90]</a><span><span><span><span><span>. Relies heavily on <b>G</b>
to find objects by GUID (e.g. token
source bags G.tokenSources. <i>used in onLoad to spawn tokens via
hotkey</i></span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L311-L319">[67]</a><span><span><span><span><i>). Uses</i><span> <i>U.sequence</i> <i>for
orchestrating timed or ordered steps on load</i></span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L350-L358">[91]</a><span><span><span><span><i>, and
uses</i><span> <i>Wait</i> <i>(via U or
directly) for delays (ex: Wait 1s then highlight battlegrounds on turn
change</i></span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L372-L380">[76]</a><span><span><span><span><i>). Coordinates
with</i><span> <i>Z</i> <i>for zone
activation and UI refresh (calls </i></span></span></span></span><span><span><span><code><i>Z.refreshUI()</i></span><i> as part of init
sequence, commented but implied)</i></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L354-L362">[75]</a><span><span><span><span><i>. Also interfaces
with</i><span> <i>FourthRow F</i>*
for an expansion: e.g. HUD button �MakeFourthRow� calls </span></span></span></span></span>F.spawnFourthRowBoard()<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L250-L259">[92]</a>. The main module is the
central brain, so other parts (object
scripts, etc.) call back into it or into S: e.g., when a player chooses an
option, an object might call Global.call(&quot;advanceTurn&quot;) or
set a flag in S, which M periodically checks (not explicit here, but a common
pattern).</p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>VTMH/core/state.ttslua</b></span> (S)</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>State
tracking:</i> Maintains structured state for the
campaign: player data, round/turn, tokens, etc.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Provides
functions like <b>S.setGameState(table)</b> � to load a saved state table
into the </span></span></span></span></span>gameState global (or an internal
structure)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L302-L310">[66]</a><span><span><span><span><span>; <b>S.getGameState()</b> �
to produce a table for saving (used in
onSave). Utility checks: <b>S.isInPhase(name)</b>, <b>S.isInMode(name)</b> �
to check current phase/mode; <b>S.setStateVal(value, ...keys)</b> � update
nested state (as seen in KD�s lighting: </span></span></span></span></span>S.setStateVal(mode, &quot;lights&quot;, lightName) stores the mode of a
light<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L648-L656">[93]</a><span><span><span><span><span>). Likely keeps
<i>player-specific</i> sub-tables (for Prestige,
etc.), <i>board state</i> (tokens positions, whether certain cards used), and
flags like </span></span></span></span></span>allZonesLocked. May also handle derived
values like �current leader� or �round number.�</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><b>Observed
in repo:</b> The onLoad in M uses </span></span></span></span>S.setGameState(newState)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L302-L310">[66]</a> and onSave returns
gameState JSON<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L50-L53">[62]</a>, implying S bridges between
the flat <span><span><span><span>gameState<span> table and more convenient
accessors. Many modules use S: e.g., <b>Z</b> checks </span></span></span></span></span>S.isInPhase(&quot;SCORING&quot;) or
similar to decide behavior<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L86-L95">[94]</a><span><span><span><span><span>; <b>M.advanceTurn</b>
likely increments S.turn and handles
wrap-around. Heritage�s state might include campaign persistence
(usedAbilityStickers etc., as hinted by commented code filtering
</span></span></span></span></span>Kindred5 sticker<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L302-L310">[66]</a>). S probably also
implements toggles like S.isDebugging() (seen used in
M.onPlayerAction to allow admin deletions<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L384-L393">[79]</a><span><span><span><span><span>). It depends on
<b>lib.constants</b> (C) for phase/mode identifiers
and on <b>U</b> for utilities like filtering tables.</span></span></span></span></span></p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>VTMH/core/zones.ttslua</b></span> (Z)</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Zone
event handling and board UI:</i> Manages scripting zones
(areas on the board that react to object entry/exit) and updates the UI
elements related to zones (like suspicion markers, score
displays).</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><b>Z.onLoad()</b> � Called during module onLoad to do any setup (here
it calls </span></span></span></span>Z.updateBloodlineZones() to prepare
internal mappings of zone relationships)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L43-L50">[95]</a><span><span><span><span><span>.
<b>Z.updateBloodlineZones()</b> � sets up reference links between
zones of different generations for lineage tracking</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L48-L56">[96]</a><span><span><span><span><span> (e.g. mapping a child�s
zone to its parent zone GUID for later
lookup). <b>Z.onObjectEnterZone(zone, obj)</b> and <b>...LeaveZone</b> �
(Assigned dynamically via Global�s ActivateZones/DeactivateZones
functions</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L33-L41">[61]</a><span><span><span><span><span>) � likely respond to cards
entering bloodline slots, triggering
checks like: if a card is placed in a higher generation zone than its clan
leader, mark suspicion or handle trait inheritance. Specifically, functions
like <b>Z.isInOtherBloodlineZone</b> and <b>Z.isInHigherBloodlineZone</b> are
provided to detect if an object was dropped in an �illegal� lineage
spot</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L67-L76">[97]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L80-L88">[98]</a><span><span><span><span><span>. <b>Z.getCards(zone)</b>
(implied by usage in
Z.isInHigherBloodlineZone) � returns cards present in a zone. <b>Z.getZoneColor(zone)</b>
� determines which player (color) a zone belongs to (useful if each player
board has zones for their clan)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L57-L65">[99]</a><span><span><span><span><span>. <b>Z.hideZones() /
showZones()</b> � Admin utilities to literally
move all scripting zones off-table (by shifting their Y position far down) and
back</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L130-L138">[100]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L145-L154">[101]</a>, used to declutter view or
pause triggers (this is tied to the HUD
toggle �Zone Visibility� which calls Z.hideZones() or Z.showZones() via Global)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L87-L93">[102]</a>. These also lock/unlock
zone responses by updating a state flag and
UI text (e.g. coloring a debug button red/green and labeling �Zones
(Inactive)� or �(Active)� accordingly)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L114-L122">[103]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L123-L131">[104]</a><span><span><span><span><span>. <b>Z.refreshUI(zone?)</b>
� likely refreshes any on-board UI
elements that reflect zone states (e.g. an overlay showing suspicion level).
In snippet, we see it clearing a zone�s UI (</span></span></span></span></span>zone.UI.setXml(&quot;&quot;)) and then
setting a new one via zone.UI.setXmlTable(XML)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L2-L9">[105]</a>, so each zone might have
its own UI panel that�s dynamically updated
(for example, showing a number of cards or a clan symbol on that
zone).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Uses <b>G</b>
(guids) extensively: it has pre-defined GUID arrays for zones grouped by
player and type (e.g. </span></span></span></span></span>G.zones.battlegroundZones.left/center/right to identify which battleground a zone
belongs to<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L34-L41">[106]</a>;
<span><span><span><span>G.zones[color].bloodline<span> for each
player�s family tree zones). Relies on <b>U</b> for common tasks � mapping
and filtering lists of objects, rounding coordinates</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L70-L78">[107]</a><span><span><span><span><span>, etc. It calls <b>Global
UI</b> functions (via </span></span></span></span></span>UI.setAttribute) to update debug button
text<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L116-L125">[108]</a>. Also calls back to Global
to fully toggle zone listeners (Global.call(&quot;ActivateZones&quot;)
simply reassigns global onObjectEnterZone to Z.onObjectEnterZone, etc., as seen in
ActivateZones/DeactivateZones)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L115-L123">[109]</a><span><span><span><span><span>. Depends on <b>S</b> for
reading state flags (e.g. </span></span></span></span><span><span><span>allZonesLocked<span>) and on <b>C</b> for any
constants (like list of Colors).</span></span></span></span></span></p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>VTMH/core/fourthRow.ttslua</b></span> (F)</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>�Fourth
Row� expansion logic:</i><span> Handles an optional extra
board for additional content (e.g. advanced characters or the <i>Legacy</i>
content in Heritage). This module dynamically spawns and manages an extra row
of cards if activated.</span></span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><b>onLoad()</b> � This is an object script (notice it�s not a function in an F
table, but a top-level </span></span></span></span>onLoad in the file)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L69-L78">[110]</a>. Likely this script is
intended to be attached to a template
�FourthRowBoard� object that exists in the base mod, because it checks
if self.guid == G.playerObjs.fourthRowBoard then ... to decide if it�s the
original template (in which case it nullifies
global BOARD_Lock/Unlock functions to avoid
confusion)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L69-L77">[111]</a><span><span><span><span><span>. For <i>cloned boards</i>,
onLoad will run the else branch: if the
board is locked (</span></span></span></span></span>self.getLock() true), it shows a small UI
with an �+� or unlock button<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L70-L78">[112]</a> � here it sets
self.UI.setXmlTable(boardXML.locked)
which likely shows a small �&#10133;� button on the board<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L22-L31">[113]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L50-L59">[114]</a>. If the board is unlocked
(cloned and unlocked), it highlights the
board red and shows a �LOCK� button UI via boardXML.unlocked<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L52-L60">[115]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L74-L78">[116]</a><span><span><span><span><span>. It defines
<b>BOARD_Lock</b> and <b>BOARD_Unlock</b> functions
(probably as global functions when the board�s UI buttons are clicked). Those
would lock/unlock the board and perhaps call </span></span></span></span></span>F.lockBoard or <span><span><span><span>F.unlockBoard<span> internally. <b>F.spawnFourthRowBoard(color)</b>
� Called when the GM uses the HUD button to create a Fourth Row for a
player</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L250-L259">[92]</a>. It clones a hidden
template board (sourceBoard = getObjectFromGUID(G.playerObjs.fourthRowBoard)) to a designated
position for that player�s board<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L88-L97">[117]</a>, tags it with the player�s
color, and adds Snap Points for new
cards/tokens on it<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L92-L101">[118]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L100-L108">[119]</a><span><span><span><span><span>. Then it likely calls
<b>F.unlockBoard(board, true)</b> to
initialize it unlocked for editing. <b>F.unlockBoard / lockBoard(board)</b> �
(Implied) would switch the board�s lock state and swap its UI between the
�LOCK� and �+� button. <b>spawnZones(board)</b> � After spawning a board,
creates new scripting zones on it for card placement: clones a hidden
template zone for each slot on the fourth row board (3 for characters and 3
for titles, as indicated by coordinates)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L150-L159">[120]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L160-L169">[121]</a>, tags them �FourthRow�, and
records their GUIDs into S.playerZones[color] state<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L170-L176">[122]</a><span><span><span><span><span>. <b>killZones(board)</b> �
Removes zones associated with a board
being deleted: looks up the zones from the board�s description or stored
state and destroys them, updating state accordingly</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L134-L143">[123]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L140-L148">[124]</a>.</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><b>Observed
in repo:</b><span> The FourthRow uses a mix of <b>object UI</b>
(via </span></span></span></span></span>self.UI.setXmlTable on the board itself
for on-board buttons)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L72-L78">[125]</a><span><span><span><span><span> and <b>spawning/cloning TTS
objects</b> (for boards and zones)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L88-L97">[117]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L160-L169">[121]</a><span><span><span><span><span>. It leverages <b>G</b> for
GUID of the template board and template
zone. Depends on <b>S</b> to store the GUIDs of newly spawned zones per
player (so they persist and can be cleaned up)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L170-L176">[122]</a><span><span><span><span><span>. Uses <b>U</b> for table
operations (concatenating GUID lists,
decoding board description which likely contains CSV of zone
GUIDs)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L140-L148">[124]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L172-L176">[126]</a><span><span><span><span><span>. Coordinates with
<b>Z.updateBloodlineZones()</b> after changing
zones, so the zone logic is aware of the new zones</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L174-L176">[127]</a>. This component
demonstrates how to avoid duplicate scripts by using
one template object�s script to govern all its clones� behavior (each cloned
board gets the same script automatically, which handles its own UI and
locking).</p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>VTMH/lib/constants.ttslua</b></span> (C)</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>Constants:</i> Defines static lists like clan names, trait types,
phases, etc.,
specific to Heritage.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Expect
lists such as <b>C.Clans = {&quot;Brujah&quot;,&quot;Gangrel&quot;,...}</b>,
which are used to tag cards or determine player colors (M.findClanTag uses
object tags to infer clan</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L66-L74">[128]</a>). Also phase identifiers
like C.Modes = { INIT=&quot;INIT&quot;, PLAY=&quot;PLAY&quot;, ... } and possibly
numeric constants (max rounds, token values). Contains
UI assets references (image names like �ref-players�,
�hud-toggle-battlegrounds�) corresponding to image assets in the mod (since
the HUD XML refers to image names<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L72-L80">[129]</a>).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><span>Used
throughout: <b>M.getColorOfClan(clan)</b> likely uses C.Clans or a map of
clan-&gt;color. <b>Z</b> might use lists of colors from C. <b>UI XML</b>
relies on image names defined somewhere (maybe in constants or just in the
mod�s asset pack). Essentially pure data.</span></span></span></span></span></p>
</td>
<span></span>
</tr>
<tr>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><code><b>VTMH/lib.guids.ttslua</b></span> (G)</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p><span><span><span><span><i>GUID
Registry:</i> A structured table of all important object
GUIDs in the Heritage mod.</span></span></span></span></p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Likely
organized by categories: G.battlegrounds (with entries .a, .b, .c... or named like .right, .center, .left mapping to GUIDs
of those boards) � we see usage like G.battlegrounds.i in testFunc2<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L22-L30">[60]</a> and
G.battlegrounds.d in HUD_checkSuspicion<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L62-L70">[130]</a>, suggesting a mapping by
scenario letter. Also G.globalSpots.character for the Character
deck spot (used to find deck above it)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L152-L160">[131]</a>.
G.tokenSources.power etc. for bags of
tokens<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L311-L319">[67]</a>.
G.storage.main for the main storage bag
(cards archive)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L146-L154">[132]</a>.
G.playerObjs.Red/... for objects specific
to each player (e.g. scheme card spots, scheme discard piles, perhaps Haven
boards). G.zones likely holds zone GUID arrays (as
seen in zones logic usage<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L36-L41">[133]</a>).</p>
</td>
<span></span>
<td style='padding:0cm 5.4pt 0cm 5.4pt'>
<p>Used
everywhere in place of hard-coded GUID strings: improves maintainability
(change one GUID in G if object gets replaced). For example, instead of
getObjectFromGUID(&quot;abc123&quot;),
code calls getObjectFromGUID(G.tokenSources.infamy)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L324-L331">[134]</a>. It�s crucial for mapping
physical components to code. No external
dependencies (just data).</p>
</td>
<span></span>
</tr>
</table>

<p><span><span><span><span><i>Table
2: Key scripts in VTM Heritage module.</i></span></span></span></span></p>

<p><span><span><span><span><b>�How
it runs� � Module initialization &amp; flow:</b><span><br>
- <b>King�s Dilemma:</b> On loading the mod, the global script executes and <b>includes
all submodules</b> (via custom require)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L26-L34">[1]</a>. The global table
gameState is prepared<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L35-L41">[6]</a>, and event handlers are set up
inside <span><span><span><span>listeners.ttslua<span>. When TTS triggers <b>onLoad</b>,
the </span></span></span></span></span>onLoad in listeners runs: it calls S.InitializeGameState(save_data) to build
the game state from saved data (or defaults) and then immediately displays a
�sessionPreflight� UI panel<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L48-L56">[7]</a><span><span><span><span><span> � presumably prompting the host
to initialize the game. This means the
KD module uses a <b>two-step init</b>: a <i>Preflight</i> (perhaps setting
Chronicle type, etc.) then <i>Session Init</i> (finalize player seating), as
seen in the admin UI XML with separate Preflight and Session
buttons</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L23-L31">[26]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L24-L32">[135]</a><span><span><span><span><span>. After initialization, play
progresses through phases controlled by
the <b>Director (DIR)</b>, which updates phase in state and calls
</span></span></span></span></span>UpdatePhaseDisplay to refresh the UI<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L282-L290">[49]</a><span><span><span><span><span>. As players take turns voting,
the <b>Voting (V)</b> module and <b>Players
(P)</b> module coordinate to handle votes and camera changes (see
</span></span></span></span></span>onPlayerTurnStart using P.SetCamera to
position the current player�s view<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L64-L67">[9]</a><span><span><span><span><span>). Throughout play, <b>Lighting
(L)</b> is used to enhance feedback �
for example, when a secret agenda card is chosen, it sets a spotlight on the
next player</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L119-L128">[136]</a>, or when tokens move, stability
lights flash momentum changes<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L152-L160">[137]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L176-L184">[138]</a>. The game state (stored in S and
gameState) is continuously updated: on each
significant action, state variables are set (e.g. lights� modes
stored<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L643-L651">[43]</a><span><span><span><span><span>, token positions possibly
tracked). When the game is saved or closed, <b>onSave</b>
in listeners encodes the state to JSON</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L52-L55">[8]</a><span><span><span><span><span> so that all persistent info
(resources levels, which dilemmas have
been resolved, etc.) will be restored next load. In summary, KD�s flow is <i>event-driven</i>
via the listeners: global events funnel into the game logic (state updates, UI
changes, lighting effects), and the Director/Voting modules advance the
structured narrative of the legacy game.</span></span></span></span></span></p>

<p><span><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><b>VTM Heritage:</b> The Heritage module sets up global
events slightly differently. In
</span></span></span></span>heritage.ttslua, the global onLoad is directly assigned to M.onLoad<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L44-L47">[139]</a>, so when the game loads, it
invokes <span><span><span><span>core/main.onLoad<span>. <b>M.onLoad</b> performs
an extensive initialization: it loads saved state via S</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L302-L310">[66]</a>, spawns helper objects or finds
them by GUID (bags of tokens, decks)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L311-L319">[67]</a>, and creates global Hotkey
bindings so that the GM/players can press
keys to spawn tokens under their cursor<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L316-L325">[68]</a> (a convenience feature for this
RPG/legacy hybrid). It then uses U.sequence to execute a series of setup
steps with short delays<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L350-L359">[70]</a>. These steps activate scripting
zones (Z.activateZones) and refresh any zone-based
UI (Z.refreshUI), ensure pieces that should
start hidden are invisible to players (invisObjects moves them below the table or
sets setInvisibleTo as needed), lock certain
objects (lockObjects) so they aren�t interactable
until needed<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L79-L87">[73]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L80-L84">[140]</a>, and highlight specific areas
(e.g. <span><span><span><span>M.highlightBattlegrounds<span> likely pings the
mini-game boards for players to notice). Once onLoad is done, the module waits
for player input via the HUD. The <b>HUD UI</b> for Heritage (defined in
</span></span></span></span></span>VTMH/xml/hud.xml) provides the GM with a
sidebar of toggle buttons for various reference images and game
phases<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L66-L75">[141]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L92-L101">[142]</a>. For example, when the GM clicks
�Start Game� (HUD_startGame), it
calls M.gameSTART() which in turn might shuffle
decks, draw initial hands, and set S.phase = &quot;PLAY&quot;. Players have
their own HUD (the XML defines sections for Red, Yellow, Blue separately with
visibility per color<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L74-L82">[143]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L146-L154">[144]</a>) which likely show reference info
like clan symbols or a condensed
rule reminder when they click the icons (the HUD_show and HUD_hide functions handle these toggles<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L250-L259">[92]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L260-L269">[145]</a><span><span><span><span><span>). During play, as cards are
played onto the table or into <b>scripting
zones</b> (like family tree slots or battlegrounds), the <b>Z module</b>
triggers: e.g., if a card is placed in an incorrect generation slot, Z might
mark it for suspicion (perhaps by highlighting the card or incrementing a
counter). The zone logic uses a throttle to prevent rapid-fire triggers
(multiple cards dropped at once)</span></span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L23-L31">[146]</a><span><span><span><span><span>. Meanwhile, other subsystems
track ongoing status: <b>Traits and stickers</b>
� Heritage involves putting stickers on cards; functions like </span></span></span></span></span>M.askTraitsUpdate() (HUD_updateTraits)
presumably prompt the host to update trait effects at end of round<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L146-L149">[147]</a>. When the game advances phases
(e.g. to Aftermath or End), the HUD
�scoreGame� or �endGame� buttons call M.gameSCORE() or M.gameEND(), which use the data in S (like
player scores, usedAbilityStickers, etc.) to finalize the game outcome. On game
save, the global onSave simply serializes the entire gameState table<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L50-L53">[62]</a><span><span><span><span><span> � since M/S have kept that table
updated, it will include all
necessary info (e.g. which missions are done, which clans were chosen by which
players, etc.). On reload, M.onLoad uses that to restore everything. <b>In
short</b>, the Heritage module relies on a central </span></span></span></span></span>gameState and orchestrates a lot through
the UI � the GM�s HUD drives the progression, while automated parts (zone
triggers, token auto-moves on delete) simplify bookkeeping. The design keeps
object scripts fairly minimal (most heavy logic is in M or Z). This makes
adding new content (like the Fourth Row expansion) easier � e.g. the FourthRow
module simply provides spawn/cleanup functions and a template object with its
own small script, all invoked by a HUD button. State and rules live in the
central modules, avoiding copy-paste across many object scripts.</p>

<p>&lt;a
name=&quot;ui-hud-handbook&quot;&gt;&lt;/a&gt;</p>

<h2><a name="uihud-handbook-end-to-end"></a></h2>

<p><span><span><b>How interactive
UI/HUD elements are built:</b><span> Both modules use <b>XML-defined
UI layouts</b> combined with Lua event handlers to create dynamic, interactive
HUDs. In the repo, UI is split into static XML (defining structure and visual
elements) and Lua functions that respond to user input and update the UI.</span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><b>Structure (XML):</b> The Heritage module
provides a great example in </span><span>VTMH/xml/hud.xml<span>. It defines a <b>sidebar
panel</b> for the Storyteller (visibility �Red� � presumably the GM�s
color) containing a vertical stack of image-buttons</span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L66-L74">[148]</a>. Each button
has an id like
&quot;hudRefBattlegroundsRed&quot; and uses classes for styling (size, background)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L72-L80">[129]</a>. There is a
matching invisible �overlay� image for each, with id ending in ...Overlay, that is initially clear
and used for highlighting on hover<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L158-L166">[149]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L170-L176">[150]</a>. The XML
attaches events to these elements: for instance, each reference icon &lt;Image&gt; uses onMouseDown=&quot;HUD_show&quot; and onMouseUp=&quot;HUD_hide&quot;, and
hover events onMouseEnter=&quot;HUD_highlight&quot; / onMouseExit=&quot;HUD_dim&quot;<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L48-L56">[151]</a>. This means:
when the user clicks down on an icon, it calls the global function HUD_show, and when they release, it
calls HUD_hide. Similarly,
hovering triggers highlight functions. This setup is
uniform for all the reference icons by using XML defaults and classes. The
actual large reference images (the content to show) are also defined in
XML: e.g., an &lt;Image
id=&quot;RefBattlegroundsRed&quot; class=&quot;hud-ref-image&quot;
image=&quot;ref-battlegrounds&quot; active=&quot;false&quot; /&gt; which is
the full image, initially hidden<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L4-L11">[152]</a>. Each
content image corresponds to a toggle button (id without �hud�). The
King�s Dilemma module�s UI is also defined via XML in kingsdilemma/kdxml/admin.xml: it
defines an admin panel visible only to the host<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L23-L31">[26]</a> with buttons
for Preflight, Session Init, advancing phases, etc., and a collapsible
section of admin tools<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L46-L54">[27]</a>. Those
buttons have IDs like �initSession�, �advanceGamePhase�, �resetTable�,
etc. and no explicit onClick in XML, implying the default is to call a
global function with the same name as ID (or they use the pattern of
catching them in a general handler).</li>
<li><span><span><b>Event wiring (Lua):</b> In Heritage, the
global script implements </span></span>HUD_show, HUD_hide, HUD_highlight, <span><span>HUD_dim<span> to fulfill the XML�s
callbacks. <b>Observed in repo:</b> The </span></span></span>HUD_show(player, value, id) function
takes the element id (e.g. �hudRefBattlegroundsRed�) and performs the
toggle logic<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L250-L259">[92]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L260-L269">[145]</a>. It strips
the prefix �hud� to get the content image ID (�RefBattlegroundsRed�)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L250-L259">[92]</a>. If the
content is already visible (it checks UI.getValue(id) which they set to
&quot;ON&quot; when latched open), then HUD_show will actually hide it: it
clears the value, hides the image, and resets the overlay color<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L260-L269">[145]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L270-L275">[153]</a>. If it�s not
visible, it will show the image (and if the click was a right-click value == &quot;-2&quot;, it sets the
toggle to ON so it stays open)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L266-L274">[154]</a>. Similarly, HUD_hide only hides the content image
if it�s not latched �ON� (so a quick left-click displays the image until
mouseUp, then HUD_hide hides it)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L272-L280">[155]</a>. The
highlight functions just change the overlay tint: HUD_highlight sets the overlay image�s
color to white (or a brighter color)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L276-L284">[156]</a>, and HUD_dim sets it back to clear if the
button isn�t latched on<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L280-L288">[157]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L281-L285">[158]</a>. In King�s
Dilemma, the event wiring is a bit different: the admin XML has specific
button IDs (like �initSession�), and the Lua side uses a generic handler <span><span>HUD_Click(player, btn, id)<span>. That
function pattern-matches the id and calls the appropriate function. <b>Observed
in repo:</b> In </span></span></span>kingsdilemma/hud.ttslua,
HUD_Click checks for
prefixes and exact matches<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L254-L263">[16]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L264-L271">[45]</a>. For
example, if id ==
&quot;initSession&quot; it calls DIR.InitSession()<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L262-L270">[17]</a>. If id starts with &quot;toggleElem_&quot;, it calls a
helper to toggle the visibility of a UI panel (e.g. clicking a &#9658;
arrow to expand a section)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L260-L263">[159]</a>. This design
routes many buttons through one function using if/elseif or pattern
matching (regex on id). It�s very scalable: adding a new button means
giving it an ID and handling it in that function. Heritage took a slightly
different approach by leveraging consistent naming and separate functions
for different event types (<span><span>HUD_show<span> for all reference images,
etc.), which is also fine. <b>Best practice:</b> Use whichever mapping
keeps code clear � for a few disparate buttons, a big if/elseif in one </span></span></span>onClick handler is okay; for many
similar buttons, factoring by naming convention (as Heritage did) reduces
code repetition.</li>
<li><span><span><b>Updating UI state:</b><span> The modules update UI
elements on the fly using TTS�s UI API. For instance, King�s Dilemma�s
vote buttons: when a player votes Aye/Nay/Pass via the UI, the script
changes the colors of the buttons and text to reflect the choice. <b>Observed
in repo:</b> In </span></span></span>HUD_Click, after
processing a vote button, they call UI.setAttribute(&quot;turnHUD_voteAye_Text_&quot;..color,
&quot;color&quot;, &quot;rgba(1,1,1,1)&quot;)
to highlight the chosen option�s text<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L36-L44">[160]</a> and set the
other options to a dimmer color<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L54-L62">[161]</a>. They also
change the button�s background color (e.g. if vote = Aye, tint the button
blue)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L38-L46">[162]</a>. These
updates give immediate visual feedback. Similarly, Heritage�s zone toggle
updates the debug button label: UI.setAttribute(&quot;debugToggleZones&quot;, &quot;text&quot;,
&quot;Zones (Active)&quot;) and color green
when activated<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L122-L130">[163]</a>, or red for
inactive<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L115-L123">[109]</a><span><span><span>. The <b>UI
is essentially a live DOM</b>: you can show/hide elements, change text,
images, colors, etc., via the UI.* functions. Both modules use this to
provide feedback (e.g., updating phase names on screen, highlighting
selections, showing temporary prompts).</span></span></span></li>
<li><span><span><b>Animations/Feedback:</b><span> While UI elements
can be manipulated, some �animations� are done via object movement or
effects rather than UI. For example, <b>flashing lights or moving pieces</b>
are used to draw attention. King�s Dilemma simulates an animation when
secret agendas are dealt: the card is moved slowly to a spot with </span></span></span>U.setPositionSlow(obj, targetPos, 1)
which presumably interpolates over 1 second<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L110-L118">[164]</a><span><span><span>. They also
use <b>highlighting</b> (a colored outline glow) on objects or lights �
e.g. </span></span></span>light.highlightOn(Color[playerColor]) to mark which light corresponds to a player<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L543-L550">[165]</a>. In
Heritage, feedback is given by physically moving tokens when cards are
deleted (e.g., deleting a �ClanScheme� card teleports it to that clan�s
discard pile with a smooth rotation using setPositionSmooth and setRotationSmooth)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L420-L428">[166]</a>. These are
not UI per se, but part of the UX. If purely UI-based animations are
needed (e.g. flashing an on-screen icon), one can toggle a UI element�s
visibility or color in a timed sequence (using <span><span>Wait.time<span> or a coroutine). The repo
doesn�t show a lot of animated UI � instead it uses <b>coroutines</b> and
sequences for complex flows (like message queries). For example, KD�s </span></span></span>MSG.SplashQuery likely displays a UI
panel with options and waits for MSG.QueryResponse to be set, as hinted
by their test code using U.RunSequence to display a query and
then either show a follow-up splash depending on the answer<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L76-L84">[167]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L90-L98">[52]</a>. They even
highlight the UI options on hover via HUD_HoverOn/off (changing text color
and background of selected option)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L316-L324">[18]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L327-L335">[168]</a> for a
polished feel. In summary, animations/feedback in these modules are
achieved through a combination of UI tweaks (color changes, visibility
toggles) and in-world actions (moving/highlighting objects), orchestrated
by utility functions (U.sequence,
U.Lerp,
etc.).</li>
</ul>

<p><span><span><b>Building
similar HUD elements today:</b> The patterns observed can
be applied to any TTS module, including a new VTM5E one:</span></span></p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><b>Minimal HUD panel with buttons
and dynamic text:</b><span> You can define a simple XML with a
panel and some buttons, then update it via script. <i>Example:</i> A small HUD
to track �Hunger� (for VTM5E). In XML:</span>
</span></span></p>

<p><span><span>&lt;Panel
id=&quot;hungerPanel&quot; visibility=&quot;All&quot; height=&quot;50&quot;
width=&quot;200&quot; position=&quot;0 30 -40&quot;
rectAlignment=&quot;LowerCenter&quot;&gt;<span><br>
</span></span><span>���
&lt;HorizontalLayout
childAlignment=&quot;MiddleCenter&quot; /&gt;<span><br>
</span></span><span>��� &lt;Text
id=&quot;hungerLabel&quot;
text=&quot;Hunger: 0&quot; color=&quot;#FF0000&quot; fontSize=&quot;18&quot;
/&gt;<span><br>
</span></span><span>��� &lt;Button
id=&quot;increaseHunger&quot;
text=&quot;+1&quot; onClick=&quot;HUD_increaseHunger&quot; /&gt;<span><br>
</span></span><span>��� &lt;Button
id=&quot;decreaseHunger&quot;
text=&quot;-1&quot; onClick=&quot;HUD_decreaseHunger&quot; /&gt;<span><br>
</span></span></span>&lt;/Panel&gt;</p>

<p>This defines a
panel visible to all, showing a text and two buttons. In Lua, you implement:</p>

<p><span><span>hunger = 0� --
track state<span><br>
</span></span><span>function
HUD_increaseHunger(player, val, id)<span><br>
</span></span><span>��� if hunger
&lt; 5 then hunger = hunger + 1
end<span><br>
</span></span><span>���
UI.setAttribute(&quot;hungerLabel&quot;,
&quot;text&quot;, &quot;Hunger: &quot;..hunger)<span><br>
</span></span><span>end<span><br>
</span></span><span>function
HUD_decreaseHunger(player, val, id)<span><br>
</span></span><span>��� if hunger
&gt; 0 then hunger = hunger - 1
end<span><br>
</span></span><span>���
UI.setAttribute(&quot;hungerLabel&quot;,
&quot;text&quot;, &quot;Hunger: &quot;..hunger)<span><br>
</span></span></span>end</p>

<p>This uses UI.setAttribute to update the label text
whenever a button is clicked. (Here we keep hunger in a global variable, which
would also be saved via onSave if needed.)</p>

<p><span><span><b>Observed in repo:</b> The use of
</span></span>UI.setAttribute to change
text is exactly how KD updates vote outcomes<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L54-L62">[161]</a> and Heritage
updates debug labels<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L115-L123">[109]</a> � straightforward
and efficient.</p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><b>Modal dialog
workflow:</b> TTS offers
built-in pop-ups: </span></span>Player.showInputDialog,
showConfirmDialog, and
showOptionsDialog for
simple modals. The repo demonstrates showInputDialog usage: KD�s test
functions call Player.Red.showInputDialog(&quot;What
shall we name it?&quot;, &quot;Fetched Object&quot;, callback)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1006-L1014">[169]</a> as part of a
sequence, waiting until the player inputs text. Similarly, showOptionsDialog is used to ask which
camera angle to use<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L38-L46">[170]</a>. These are
easy modals: they pause the code only in the sense that you give a
callback, but if you need to truly sequence events around them, you use a
coroutine or U.waitUntil. In KD, they
wrapped modal usage in U.RunSequence so that the script waits
until an answer is ready<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1008-L1016">[171]</a>. For
example, to prompt a Yes/No question to a player and then act on it:</li>
</ul>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>function
askYesNo(color,
question, callback)<span><br>
</span>
</span><span>��� local
response = {yes=false}<span><br>
</span></span><span>���
Player[color].showConfirmDialog({<span><br>
</span></span><span>�������
title=question,<span><br>
</span></span><span>�������
onYes=function() response.yes=true end,<span><br>
</span></span><span>�������
onNo=function() response.yes=false end<span><br>
</span></span><span>���
})<span><br>
</span></span><span>��� -- We need to
wait until player responds:<span><br>
</span></span><span>���
U.waitUntil(function()
callback(response.yes) end,<span><br>
</span></span><span>���������������
function() return response.yes
~= nil end)<span><br>
</span></span></span>end</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>This pseudo-code uses
</span></span>showConfirmDialog (which doesn�t provide a
direct wait, so we use U.waitUntil to poll a flag). In practice, showConfirmDialog might not easily
integrate with Wait, so using <span><span>showOptionsDialog<span> with a custom UI might be
better for complex flows. The KD module instead did their own splash query UI: <i>Observed
in repo:</i> they had </span></span></span>MSG.SplashQuery(question,
target, optionsTable, playerColor) to pop up a
custom UI with buttons<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L80-L88">[172]</a> and then MSG.QueryResponse(index) triggered by
button click<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L256-L264">[173]</a>. They highlight
options on hover<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L316-L324">[18]</a> and dim on exit<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L328-L336">[174]</a><span><span><span>. This is a robust
modal simulation: essentially a UI panel functioning as a modal, controlled by
global script. For your needs, you might not need that complexity initially �
using TTS�s built-ins or a simple Yes/No UI can suffice. The key is to <i>pause
game logic until input arrives</i>. The repo�s <b>coroutine approach</b> (</span></span></span>U.RunSequence with a function returning a
test that waits for input)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1000-L1009">[175]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1010-L1018">[176]</a> is an excellent
blueprint for making sequential scripts that involve player decisions. You can
use their U.RunSequence directly (see
section 5) to queue: show modal -&gt; wait -&gt; process
result.</p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><b>Role-based UI (Storyteller vs
Player):</b>
Both modules demonstrate controlling UI visibility by player role. In TTS,
every UI element can have a </span><span>visibility<span> attribute listing who can
see it. <b>Observed in repo:</b> Heritage�s HUD XML uses </span></span></span>visibility=&quot;Red&quot; for
GM-exclusive panels<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L66-L74">[148]</a>, and
separate sections for �Yellow� and �Blue� players with their own
visibilities<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L73-L81">[177]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L144-L151">[178]</a>. This means
the GM (assuming they sit in Red seat) sees the GM sidebar, while players
(in Yellow/Blue) see only their sections (which likely contain reference
images or personal info). To implement role-based UI:</li>
</ul>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><span>Decide on a color to represent the
Storyteller (you could use the <i>Game Master</i> (Grey) color, but Grey is
invisible by default; many mods assign GM to a regular color like Brown or Red
for convenience, as done here).</span>
</span></span></p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>In your UI XML, tag GM-only
controls with
</span></span>visibility=&quot;Brown&quot; (if you use Brown for ST) or another chosen color that players won�t
use. Conversely, if you have player-specific info, give each element a
visibility for that player�s color. The Heritage mod did this to show each
clan�s reference card only to the player of that clan (and the GM, since GM can
choose to view as any color or just include GM in all visibility lists).</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Alternatively, you can control
visibility via script:
</span></span>UI.hide(id,
color) and UI.show(id, color) allow
showing/hiding an element for specific players. For example, you
could create an ability for the ST to �reveal� a note to one player by showing
a UI panel only to that player�s color. However, setting up via XML is simpler
for static role divisions.</p>

<p><span><span><b>Best practice:</b><span> Use
the <b>visibility attribute in XML</b> for fixed role UIs. For
dynamic per-player content (like a secret only one player should see), consider
spawning an object in that player�s hand zone or using </span></span></span>Player[color].print() to send a private
message � because UI sent to one player currently isn�t straightforward except
by assigning a unique panel id per player. The repo sidesteps this by either
using physical objects set invisible to others (for secrets)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L109-L117">[13]</a> or simply not
showing certain UI to non-targets. For instance, if only the Blue player should
respond to a query, KD�s code can specify a target color for the splash query,
and the UI is likely only visible to that color (the MSG.SplashQuery in KD
takes a target and a player parameter<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L80-L88">[172]</a><span><span><span>, possibly
controlling who sees it). So, for VTM5E, plan your UI layout with these in
mind. Typical approach: <i>Give the GM a dedicated panel</i> (with scene
controls, NPC tools, etc., visible only to GM), <i>give each player a character
sheet panel</i> (visible only to that player and GM, so GM can also see all),
and <i>shared panels</i> for things like a common dice log or timer (visibility
All). This way, one set of UI definitions can serve different roles by using
visibility filters. The heavy lifting of showing/hiding at runtime can mostly
be avoided by clever static setup, but you can always adjust on the fly with </span></span></span>UI.setAttribute(id, &quot;active&quot;, &quot;false&quot;) or similar as needed (as
KD does to hide/show sections on toggling)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L182-L190">[179]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L194-L200">[180]</a>.</p>

<p><span><span><span>In summary, <b>to build interactive
HUDs</b>: Define your UI layout in XML for positioning and default look; attach
</span></span></span>onClick/onMouseEnter events in XML
that map to Lua functions; implement those Lua callbacks
in Global (or on specific objects if UI is tied to them) to handle the logic
(updating state, calling game functions) and update the UI via UI.setAttribute or <span><span>UI.setValue<span>. Use the repository�s patterns
such as generic handlers with ID pattern matching for scalability, and use <b>utility
functions to DRY up repetitive tasks</b> (the repo, for instance, uses </span></span></span>toggleXmlElement to handle any panel
show/hide toggle by id generically<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L181-L190">[20]</a>, instead of
writing separate functions for each panel�s toggle). For dynamic feedback,
integrate object highlights/movements with UI updates to ensure players get
clear, immediate responses to their actions.</p>

<p>&lt;a
name=&quot;immersion-controls&quot;&gt;&lt;/a&gt;</p>

<h2><a name="Xd74f65313fb693e2e2cb83dc7356e622a7f9b0b"></a></h2>

<p><span><span><b>Existing
module behavior (lighting &amp; ambiance):</b><span> The King�s
Dilemma module showcases advanced use of TTS lighting for dramatic effect. <b>Observed
in repo:</b> It defines multiple <b>Light objects</b> (presumably placed in the
scene, such as </span></span></span>lightLectern, lightPlayerSpotlight, lightStability, etc.) and orchestrates them
through the lighting.ttslua module. For instance, when
a resource marker moves, they call L.SetLightMode(&quot;lightStability&quot;, &quot;on&quot;) to turn on the stability
spotlight<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L153-L161">[181]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L167-L169">[182]</a>.
When a secret agenda is being chosen, they shift a �player spotlight� onto the
next player by L.SetLightMode(&quot;lightPlayerSpotlight&quot;,
&quot;player&lt;Num&gt;&quot;) (where the mode name
corresponds to that player�s angle)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L120-L128">[183]</a><span><span><span>.
Additionally, KD uses <b>ambient lighting changes</b>: toggling the debug panel
sets </span></span></span>Lighting.ambient_intensity = 1.5 and Lighting.ambient_type = 1 (brighten the
room)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L186-L194">[28]</a>,
and closing it sets intensity back to 0 (dimming the table)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L194-L201">[184]</a><span><span><span>.
This indicates an <i>ambiance control</i> where certain UI toggles simulate
light/dark mode to focus attention. Heritage�s module does less with lighting,
but it does use object invisibility for ambiance control (e.g., hiding zones by
moving them off-table changes the �mood� by decluttering visuals</span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L130-L138">[100]</a>).
Sound isn�t explicitly used in the repo (no references to sound files or music
in code), which suggests that in those modules, background music or sound
effects might have been managed manually by the host through TTS�s built-in
music player, not via script.</p>

<p><span><span><span>However, we can
extrapolate likely plans: For example, Heritage�s immersive elements might
include <b>the �swivelLight� object</b> referenced in </span></span></span>main.ttslua (it retrieves swivelLight = getObjectFromGUID(G.lights.swivel)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L108-L116">[185]</a>).
This swivel light could be used to highlight the active player�s board
(rotating to that player�s position with different colors<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L36-L44">[186]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L37-L45">[187]</a>) �
a form of ambiance spotlight. Indeed, swivelLightVals table in the code defines
�faint� and �strong� settings with different ranges/intensities and color tints
for Red, Yellow, Blue players<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L13-L21">[188]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L26-L34">[189]</a>.
It appears when a new leader is chosen, they might call something like swivelLight.setColor(...) or use <span><span>Lighting.setLightColor<span> to emphasize that
leader�s area. Summarily, <i>lighting and ambiance in the repo are used to cue
players about game states</i>: lights on tokens indicate momentum shifts,
ambient light changes indicate entering a �debug/maintenance� mode, and
spotlights indicate whose turn it is or where to look on the board.</span></span></span></p>

<p><span><span><b>Controlling lighting
programmatically:</b><span> TTS provides a <b>global Lighting
class</b> in its API for table-wide ambient and directional light, and <b>Light
objects</b> for specific spot/point lights. The repo uses both:</span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><i>Ambient and
Directional Light:</i> These are
controlled via the </span></span>Lighting static class. You can set
properties like Lighting.ambient_intensity, Lighting.light_intensity (directional
light strength), and even color settings for sky/ground (if using gradient
ambient)<a href="https://api.tabletopsimulator.com/lighting/#:~:text=Variable%20Type%20Description%20ambient_intensity%20The,Range">[190]</a><span></span><a href="https://api.tabletopsimulator.com/lighting/#:~:text=Range%20%3D%200%20to%204,Range%20%3D%200%20to%201">[191]</a>. After changing these, you call
Lighting.apply() to apply the changes<a href="https://api.tabletopsimulator.com/lighting/#:~:text=Lighting.light_intensity%20%3D%202%20Lighting.setLightColor%28,Lighting.apply">[5]</a><span></span><a href="https://api.tabletopsimulator.com/lighting/#:~:text=Function%20Name%20Return%20Description%20apply">[192]</a>. For example, to create a night
scene, you might do:</li>
</ul>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>Lighting.ambient_intensity = 0.1�
-- very dim ambient light<span><br>
</span>
</span><span>Lighting.light_intensity
= 0.2��� -- moonlight dim<span><br>
</span></span><span>Lighting.setLightColor({r=0.2,
g=0.2, b=0.35})� -- tint directional
light blueish<span><br>
</span></span><span>Lighting.ambient_type
= 1�������� -- use background ambient
(perhaps a night sky background)<span><br>
</span></span></span>Lighting.apply()</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]><b>Official docs confirm</b> these properties and
functions
</span></span><a href="https://api.tabletopsimulator.com/lighting/#:~:text=Variable%20Type%20Description%20ambient_intensity%20The,Range">[190]</a><span></span><a href="https://api.tabletopsimulator.com/lighting/#:~:text=Lighting%2C%20a%20static%20global%20class%2C,Lighting.apply">[4]</a>.
The repo example: turning on debug mode sets ambient_type = 1 and intensity 1.5
(which likely uses the background�s cubemap as ambient)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L186-L194">[28]</a>.
Changing ambient_type to 2 would use a gradient (which can be set via Lighting.setAmbientSkyColor/EquatorColor/GroundColor if you want a custom
gradient).</p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><i>Light
Objects:</i> These are placed lights
that can be controlled via their Light Component. In script, you get a
reference to a light object (by GUID or tag) and then use its </span></span>LightComponent to set properties
(enabled, range, intensity, color, spot angle). The repo created wrapper
functions (getComp(light) to get light.getComponent(&quot;Light&quot;))
and used methods like comp.set(&quot;enabled&quot;, true) or
comp.set(&quot;intensity&quot;, value).
They also animated changes by gradually interpolating those values (U.Lerp calls inside L.SetLightMode adjust range/intensity
over time<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L680-L688">[193]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L684-L692">[194]</a>). To practically control a
light object:</li>
</ul>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Ensure the object is of type Light
(in TTS, you can spawn a Light and configure its color, range, etc. in the
editor, and give it a unique name or tag).
</span></span></p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Find it in script, e.g.,
</span></span>local lightObj = getObjectFromGUID(&quot;123456&quot;).</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Enable/disable:
</span></span>lightObj.Light.setEnabled(true/false) (this
is equivalent to comp.set(&quot;enabled&quot;, bool)). In older versions, one
had to get the component; newer API might have direct properties.</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Change color:
</span></span>lightObj.setColorTint(Color.Red) will tint
the object, but for light color specifically, use lightObj.Light.setColor(Color.Red) or as
the repo does, comp.set(&quot;color&quot;, Color.Red)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L542-L550">[195]</a>.</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Move or point the light: if it�s a
Spot/Point light, you reposition the object itself or adjust its rotation to
point. The repo�s
</span></span>L.LIGHTMODES stores desired position and
rotation vectors for each mode<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L50-L59">[55]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L60-L68">[196]</a>,
and then they call light.setPositionSmooth/setRotationSmooth with those values as part
of SetLightMode<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L694-L701">[197]</a>.
For a simple control, you can directly do lightObj.setPosition(positionVector) and lightObj.setRotation(rotationVector).</p>

<p><span><span><span>The
<b>Lighting class vs Light objects</b> difference is: Lighting is global
environment light, Light objects are entities in the scene. Use Lighting for
overall brightness/sky changes, and Light objects for localized effects like
lanterns or spotlights.</span></span></span></p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><i>Backgrounds &amp; Fog:</i><span> Though not explicitly used in repo
code, note that TTS allows changing
the <b>background image (skybox)</b> via the UI or script (</span>
</span></span>Environment.setBackground() if exposed, or
via save-state). For ambiance, you might set a spooky backdrop image or fog
level. Fog of War (hiding parts of the table) can be toggled manually but not
via API as of now.</p>

<p><span><span><b>Controlling
sound programmatically:</b><span> The repo didn�t use sound
scripts, but TTS provides a <b>Music Player API</b> that can play tracks added
to the mod�s Music library. According to the API documentation, there�s a
global </span></span></span>MusicPlayer class<a href="https://api.tabletopsimulator.com/lighting/#:~:text=,Spawnable%20Objects%20%20Spawnable%20Objects">[198]</a>
with functions like MusicPlayer.play() (to resume current
track), MusicPlayer.pause(), MusicPlayer.nextTrack(), and property MusicPlayer.currentTrack index or similar.
In practice, to use it: - Preload your music or ambient sound clips into the
mod (on the Jukebox in TTS). - Then from script, you can do MusicPlayer.setCurrentTrack(trackIndex) to
select a track, and MusicPlayer.play() to start it. For
example:</p>

<p><span><span>MusicPlayer.setCurrentTrack(3)� -- select 4th track in the list (0-based vs
1-based needs verifying)<span><br>
</span></span></span>MusicPlayer.play()</p>

<p>If
you want ambient loops (like city noise, or heartbeats), you could add them as
tracks. One caution: historically, changes via MusicPlayer only affected the host in older
TTS versions (there was a bug where clients wouldn�t hear it)<a href="https://tabletopsimulator.nolt.io/1165#:~:text=I%E2%80%99m%20trying%20to%20programatically%20change,to%20change%20the%20lighting%20with">[199]</a><span></span><a href="https://tabletopsimulator.nolt.io/1165#:~:text=changes%20for%20all%20the%20players,to%20change%20the%20lighting%20with">[200]</a>,
but presumably that�s been addressed. Always test with a client to be sure.
Alternatively, you can use the sound element in UI (there�s a hidden
feature: <span><span>UI.playSound(sound_name, playerColor)<span> was
proposed but not sure if implemented). A more surefire method is <b>Sound
objects or AssetBundle audio</b>: You can create an AssetBundle with an audio
source and spawn it, or spawn TTS�s built-in Sound object (which allows one-off
sound plays). For example, if you have a sound AssetBundle named �WolfHowl�,
you can do:</span></span></span></p>

<p><span><span>local howl =
spawnObject({ type = &quot;AssetBundle&quot;, sound = true, url =
&quot;assetbundle://&lt;GUID_or_URL&gt;&quot; })<span><br>
</span></span></span>howl.AssetBundle.play()�
-- play default sound</p>

<p>Or
use howl.AssetBundle.playTriggerEffect(index)
if it has multiple. The repo uses AssetBundle.playLoopingEffect(0) on lights
(likely those lights had a visual effect)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L540-L548">[201]</a><span><span><span>.
For sounds, a simpler approach: if it�s a short effect, you can create a <i>trigger
zone</i> that when entered by an invisible token plays a sound (some creative
mods do this for area-based sound). But for your purposes, using the Music
player for background tracks and maybe a few <b>script-triggered sound effects</b>
using the Sound object (which can be triggered by </span></span></span>sound.play() if you have an object
reference) is sufficient.</p>

<p><span><span><b>Designing a �scene
system� for VTM:</b> Given VTM5E sessions can benefit from
mood changes (Elysium vs a back-alley, escalating tension, etc.), we can create
preset configurations that adjust lighting, background, and sound together:</span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><b>Define your
scenes:</b><span> For example, <i>�Elysium
Ballroom�</i> � well-lit (ambient_intensity 1.0, warm light color), gentle
background music (classical), maybe light fog = 0. <i>�Dark Alley�</i> � very
low ambient (0.2), maybe a single spotlight following a character (if you
attach a light to an NPC mini), background = night city, sound = distant
traffic or dripping water. <i>�Hunt/Chase�</i> � flashing red lighting
(maybe toggle a light on/off or use a pulsating intensity via coroutine),
sound = heartbeat or suspense track, fog = light mist. <i>�Haven�</i> �
safe house, moderate light, quiet background sound.</span></span></span></li>
<li><span><span><b>Implementing
presets:</b><span> You can create a
Lua table of presets, e.g.:<br>
<![if !supportLineBreakNewLine]><br>
<![endif]>
</span></span></span></li>
</ul>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>scenes = {<span><br>
</span>
</span><span>��� elysium =
{<span><br>
</span></span><span>������� ambient =
{ intensity=1.2, type=1,
lightColor={r=1,g=0.95,b=0.8} },<span><br>
</span></span><span>������� lights =
{
{name=&quot;Chandelier&quot;, mode=&quot;bright&quot;} },� -- assume
you have a light named Chandelier
with a mode preset<span><br>
</span></span><span>�������
background =
&quot;EveningCity&quot;,� -- you might
name backgrounds if you have them<span><br>
</span></span><span>�������
musicTrack = 2<span><br>
</span></span><span>���
},<span><br>
</span></span><span>��� alley =
{<span><br>
</span></span><span>������� ambient =
{ intensity=0.1, type=2,
sky={r=0.05,g=0.05,b=0.1}, equator={r=0.1,g=0.1,b=0.1},
ground={r=0.1,g=0.1,b=0.1} },<span><br>
</span></span><span>������� lights =
{
{name=&quot;Streetlamp&quot;, mode=&quot;dim&quot;}, {name=&quot;PlayerSpot&quot;,
mode=&quot;player1&quot;} },<span><br>
</span></span><span>�������
background = &quot;NightStreet&quot;,<span><br>
</span></span><span>�������
musicTrack = 5<span><br>
</span></span><span>���
},<span><br>
</span></span><span>��� --
etc...<span><br>
</span></span></span>}</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>Then a function
</span></span>loadScene(name) would:</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Set ambient settings:
</span></span>Lighting.ambient_intensity = val etc., then
Lighting.apply()<a href="https://api.tabletopsimulator.com/lighting/#:~:text=Lighting.light_intensity%20%3D%202%20Lighting.setLightColor%28,Lighting.apply">[5]</a>.</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>For each entry in
</span></span>scene.lights, call your light controller:
e.g. L.SetLightMode(&quot;Streetlamp&quot;, &quot;dim&quot;) (which the repo�s system
can do if you adopt it) or manually set those
lights� properties.</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Change background: TTS doesn�t
have a direct API call in Lua for backgrounds as of writing, but you can
include different skybox in the mod and perhaps toggle via some trick (not
easily, unfortunately; you might have to pre-spawn a Skybox object if such
exists, but likely you�ll set it manually between games).
</span></span></p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Play music:
</span></span>MusicPlayer.setCurrentTrack(scene.musicTrack) and MusicPlayer.play().</p>

<p>You
can tie this to the UI: e.g., a GM panel with a dropdown or buttons for each
scene. The GM clicks �Elysium� -&gt; your script calls loadScene(&quot;elysium&quot;). That will
immediately fade up the lights, switch music, etc. For smooth transitions, you
can use coroutines: the repo�s U.Lerp could fade ambient_intensity over a
few seconds instead of an instant jump (though the global Lighting.apply might
not interpolate, you could simulate by small increments or use Wait loops).</p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><b>Tension
control:</b> Another idea is a �tension
meter� that gradually changes lighting color (e.g. more red as tension
increases) or volume of background sound. This could be a slider the GM
controls, which your script uses to set </span></span>Lighting.lut_index (LUT � look-up
table for color grading) to a more intense color grade, or simply spawns
an ominous red light that intensifies. The KD lighting system has
something similar: momentumUp and momentumDown modes for resource lights
tinted amber/yellow<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L47-L55">[202]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L58-L66">[203]</a>, which is analogous to a meter
moving up or down. You could
repurpose that concept: e.g., a �DangerLight� object with modes low, medium, high corresponding to
subtle, noticeable, and strong alert lighting, and when tension increases,
call SetLightMode(&quot;DangerLight&quot;, &quot;high&quot;) to make the room
bathed in red.</li>
<li><span><span><b>Sound
stingers:</b> For important moments
(e.g. a masquerade breach or an enemy appears), you can script one-shot
sound effects. For instance, if you have a �scare sound� loaded as track
or an assetbundle, call it via script at the appropriate time (possibly
triggered by a player action or button).</span></span></li>
</ul>

<p><span><span><b>Practical
guide � example:</b> Suppose the coterie enters Elysium:
you click the �Elysium� button on your GM scene control UI. The script does:</span></span></p>

<p><span><span>Lighting.ambient_intensity
= 1.0<span><br>
</span></span><span>Lighting.ambient_type
= 1<span><br>
</span></span><span>Lighting.setLightColor({r=1,
g=0.94, b=0.7})� -- warm gold light<span><br>
</span></span><span>Lighting.apply()<span><br>
</span></span><span>MusicPlayer.setCurrentTrack(1)� -- assume track 1 = gentle harp music<span><br>
</span></span><span>MusicPlayer.play()<span><br>
</span></span><span>L.SetLightMode(&quot;allLights&quot;,
&quot;default&quot;)������ -- turn on all
ambient lights<span><br>
</span></span></span>L.SetLightMode(&quot;spotlightStage&quot;,
&quot;on&quot;)������ -- stage spotlight
on Prince's podium</p>

<p>Later,
a combat breaks out in the alley: click �Alley � Combat�:</p>

<p><span><span>Lighting.ambient_intensity
= 0.2<span><br>
</span></span><span>Lighting.ambient_type
= 2<span><br>
</span></span><span>Lighting.setAmbientSkyColor({r=0.05,g=0.05,b=0.1})<span><br>
</span></span><span>Lighting.setAmbientEquatorColor({r=0.1,g=0.1,b=0.1})<span><br>
</span></span><span>Lighting.setAmbientGroundColor({r=0.05,g=0.05,b=0.05})<span><br>
</span></span><span>Lighting.setLightColor({r=0.3,
g=0.2, b=0.2})� -- slight red tint<span><br>
</span></span><span>Lighting.apply()<span><br>
</span></span><span>MusicPlayer.setCurrentTrack(4)� -- track 4 = fast-paced action music<span><br>
</span></span><span>MusicPlayer.play()<span><br>
</span></span><span>L.SetLightMode(&quot;Streetlamp&quot;,
&quot;flicker&quot;)������ -- maybe a
mode that alternates on/off<span><br>
</span></span></span>L.SetLightMode(&quot;playerSpotlight&quot;,
&quot;player2&quot;)� -- highlight the
active player (2)</p>

<p>And
so on. The key is to prepare your environment assets: get some Light objects
placed where you need them (e.g. one above each key location or an adjustable
spotlight rig), and have appropriate music tracks or ambient sounds in the mod.
The scripts from the repo (especially the lighting module) can be adapted so
you don�t reinvent the wheel � for example, the KD lighting system already
supports per-player spotlights and token-follow spotlights. You can strip out
what you don�t need and use the rest (we�ll cover extraction in section 5).</p>

<p><span><span><span>Finally, consider using
the <b>Notebook</b> or chat for ambiance textual cues � e.g. print a
descriptive passage or change the table�s <b>Notepad</b> to a particular color
scheme or text. The Notebook can be set via script (</span></span></span>Notes.setNotes(&quot;New notes&quot;))<a href="https://api.tabletopsimulator.com/notes/#:~:text=Tabletop%20Simulator%20API,This%20appears%20in">[204]</a>,
so a �scene preset� could also drop a short description into the Notebook tab
for players to read (�The lights dim as the Prince takes the stage...�). This
is a lightweight way to enhance immersion alongside visuals and audio.</p>

<p>&lt;a
name=&quot;bundling-and-code-reuse&quot;&gt;&lt;/a&gt;</p>

<h2><a name="X810b8c15c5cff7abf7758581a64d0309d1e9097"></a></h2>

<p><span><span><b>How
the repo handles code sharing:</b> The repository was
clearly organized to avoid code duplication as much as possible: both modules
draw from a common </span><span>lib/utilities.ttslua<span> (U) for generic
functions, and within each module, logic is compartmentalized into modules
(state, lighting, director, etc.) rather than copying the same code in multiple
places. <b>Observed in repo:</b> Functions like </span></span></span>U.find, U.filter, or U.RunSequence are written once in lib.utilities and then used everywhere via
the local require U<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L2-L10">[14]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L69-L77">[10]</a>.
This prevented duplicating those helpers in every script. Similarly, King�s
Dilemma defines object-specific logic in one place (e.g., kingsdilemma.objects.objUtilities with
routines to combine/split tokens) and calls those from the global event instead
of implementing splitting logic separately each time<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L78-L86">[11]</a><span><span><span>.
Another reuse approach is evident in Heritage: the <b>FourthRow board cloning</b>
� they didn�t write separate scripts for each player�s board; they wrote one
object script on the template board and spawn clones, letting that one script
handle all boards by checking </span></span></span>self tags/colors<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L80-L88">[205]</a><span><span><span>.
This is a classic TTS trick: <i>author code once on a template, then spawn or
clone objects so they all carry that code.</i> Heritage also centralizes game
flow in core/main (M), meaning all players and all phases use that single
codebase. Instead of, say, writing separate scripts for each Clan board, they
stored data in structured tables (in S and G) and wrote functions that index
into those tables by player/color. For example, </span></span></span>M.forPlayers(func) likely loops through
each player�s data and applies a function<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L180-L181">[206]</a>,
avoiding writing the same loop for each player.</p>

<p>Despite these measures,
there are a few mild duplications: e.g., the UI XML for each player�s
references is repeated for Red/Yellow/Blue in the file<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L73-L81">[177]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L144-L152">[207]</a> �
which is more data duplication (couldn�t avoid because TTS UI XML doesn�t
support templating). Code-wise, they largely avoided duplicates. Each module
has its own constants.lua even though some utility of constant (like Color
definitions, or generic tags) could be shared � they chose to duplicate
constants to keep modules self-contained. They also have separate <span><span>lib.constants<span> for KD and VTMH, presumably
because those games have very different data. The <b>utilities.lua is global</b>
(one copy) which both modules use via </span></span></span>require(&quot;lib.utilities&quot;)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L26-L30">[208]</a><span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L2-L9">[209]</a> �
so they DID share that across modules. If this repo were to be built into a
single mod containing both games, it could have even unified some parts (like
maybe one unified U and perhaps unified data structures for
any overlapping concepts), but since KD and VTMH are separate mods, the
separation is fine.</p>

<p><span><span><b>Modern recommended
workflow:</b> To develop a new TTS module (like the VTM5E
storyteller module) with maximum code reuse and minimal duplication, consider
the following approach:</span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><b>Project
Structure:</b> Organize your project
into folders by feature or component. For example:</span></span></li>
</ul>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>VTM5E-Mod/<span><br>
</span>
</span><span>� global.ttslua
(or e.g.
storyteller.ttslua)� <span><br>
</span></span><span>� core/� <span><br>
</span></span><span>���
state.ttslua� <span><br>
</span></span><span>���
scenes.ttslua� <span><br>
</span></span><span>���
npc.ttslua�
<span><br>
</span></span><span>���
combat.ttslua� <span><br>
</span></span><span>� lib/� <span><br>
</span></span><span>���
util.ttslua�
<span><br>
</span></span><span>���
constants.ttslua� <span><br>
</span></span><span>� objects/�
<span><br>
</span></span><span>���
npcCharacter.ttslua� <span><br>
</span></span><span>���
playerHandout.ttslua� <span><br>
</span></span><span>� ui/� <span><br>
</span></span><span>���
storytellerHud.xml� <span><br>
</span></span></span>���
playerHud.xml� </p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>Here,
</span></span>global.ttslua is the entry that will be the
Global script in TTS. It would require(&quot;lib.util&quot;), require(&quot;core.state&quot;), etc.,
similar to how kingsdilemma.ttslua does. You can mirror
the repo�s pattern where global script mostly bootstraps and delegates to
modules.</p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><b>External development
&amp; bundling:</b> As
you write code in multiple files, you need to get it into TTS. Options:</span></span></li>
</ul>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><span>Use TTS�s <b>built-in Lua Editor
with auto-reload</b>: TTS can be put in a mode where it watches a folder for
changes. The presence of </span>
</span></span>require(&quot;vscode/console&quot;) in the
repo suggests they used the VS Code debugging and sync extension. You can do
the same: it allows you to edit each file in VS Code and when you save, the
changes reflect in TTS (the require statements in the code are handled by the
extension which does the concatenation behind the scenes). This way, you don�t
manually bundle at all � the dev environment does it.</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><span>Use a <b>build script</b> to
concatenate files: For example, a simple Python or Node script could read </span>
</span><span>global.ttslua<span>, resolve all the require
references, and produce one big combined Lua script that you then paste into
TTS or import via the TTS API. There are community tools like <b>tts-cli</b> or
<b>TTS Lua Assembler</b> that can do this (one approach is using Lua�s </span></span></span>-- include directive comments that a
preprocessor replaces with the file content). The repo�s structure implies they
may have had a build step (the code is structured for it), though we don�t see
the actual script in the repo dump. In absence of such a tool, writing a custom
concatenator or using something like the Notepad++ TTS plugin (which can sync
multiple files) are alternatives.</p>

<p><span><span><b>Preferred
modern approach:</b><span> Use the official <b>External Editor</b>
support � it�s less error-prone and lets you maintain separate files without
manual bundling. It also supports multiple object scripts: you can have a
folder for each object�s script if you want, and a manifest JSON that maps them
to objects in the mod (this is advanced, but there�s a community workflow where
you name files after an object�s GUID and a tool injects them into a save
file).</span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><b>Shared code
authoring:</b> Identify what code
should be reused across contexts (within the mod, or even across mods).
Put general-purpose helpers in a </span><span>lib/util.ttslua<span> (like the repo�s U).
For VTM5E, you�ll likely have utilities for dice rolling, random
selection, math, string formatting, etc. Those go in util and can be used
by any core or object script. If you plan to release multiple mods or
expansions, you might even keep a <b>separate repository of utility code</b>
and include it in each project to avoid diverging copies. The key is to <b>abstract
common patterns</b>: e.g., the repo�s Wait/RunSequence logic could be
reused in any mod (so it�s in utilities). For you, maybe a generic �menu
dialog� function or �log to notebook� function could live in util for
reuse.</span></span></span></li>
<li><span><span><b>Multiple instances
of same object without copy-paste:</b> There are a couple of
techniques:</span></span></li>
<li><span><span><b>One script, many
objects via cloning</b> � as
used for FourthRow boards. You create one template object (with the script
attached) and clone it in game for each needed instance. Clones carry the
exact same script. If you need unique behavior per object, the script can
differentiate by reading some attribute (like the object�s name or tags or
description). For example, you might have a �NPC mini� script that, on
load, checks the figurine�s name to assign it certain stats or binds it to
a specific UI element. You then clone that figurine for each NPC. All
clones run the same code but operate on their own data (maybe the data is
stored in a global table keyed by GUID, or in the object�s JSON via
GMNotes). This way, if you need to fix the NPC script, you edit one file
(the template�s script) and all future clones use it; existing clones
would need an update though (you can re-copy the script to them by
copy-paste in TTS or re-spawning them).</span></span></li>
<li><span><span><b>Global or central
script controlling dumb objects</b> � some mods keep object scripts minimal (or
empty) and handle everything
in Global. For example, instead of each card having code for when it�s
dropped, they use a global onObjectDrop and check the card�s tags. The KD
mod does this for tokens: deleting tokens is handled in global
onPlayerAction</span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L384-L393">[79]</a> rather than each token having a
script. This approach means you
write logic once (in global) that applies to all relevant objects by
filtering by properties (tags, type, etc.). The disadvantage is your global
script can become large and you have to be careful distinguishing objects,
but it ensures consistency. In VTM5E context, perhaps you won�t give each
die or each card a script; you�ll catch their events in one place.</li>
<li><span><span><b>Shared library usage
in object scripts</b> �
if you do give each object a script, you can still avoid duplicating large
chunks by moving common functions to a global or library. TTS
unfortunately doesn�t let object scripts directly require global scripts,
but you can emulate it. One method is to have your global onLoad assign a
function to a global variable that object scripts can call. For instance,
global could do </span></span>function Global_rollDice(num) ... end,
then each object that needs dice roll can do Global.call(&quot;rollDice&quot;, {num=5}). The repo shows use of
Global.call(...): Heritage calls Global.call(&quot;UpdatePhaseDisplay&quot;) from several
places<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L282-L290">[49]</a>. That implies they stored an
UpdatePhaseDisplay function in Global
(probably defined in listeners or main). This is a neat trick: you
effectively expose some global functions as an API for objects. In your
module, you could expose �common� routines similarly, so objects don�t
each implement them.</li>
<li><span><span><b>Step-by-step �new
object template� process:</b> Let�s say you need to create 5 identical �Torch�
objects that
have a script to dim the light when picked up. Instead of copy-pasting
that script 5 times in TTS:</span></span></li>
</ul>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Create one Torch object in TTS,
write its script in your editor (or TTS editor) � e.g., an
</span></span>onPickup that calls self.HighlightOn(Color.Yellow) to indicate
it�s taken, and onDrop that calls a global function to
maybe reduce Lighting or something.</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><span>Once the one torch works, make it
a <i>template</i>: either save it to your Chest (so you can spawn it), or note
its GUID.</span>
</span></span></p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><span>If using a <b>spawning approach</b>:
Write a global function to spawn clones of it. TTS can clone an object by GUID
via script: </span>
</span></span>getObjectFromGUID(templateGUID).clone({position=...,
callback_function=function(newObj) ... end}). In
callback, you might assign it a new name or tag. The new clone automatically
has the same script as template. You do this as many times as needed (for 5
torches, loop 5 times).</p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>If not spawning via script, you
can manually clone in the editor (drag out copies from chest or copy-paste).
They will carry the script over intact.
</span></span></p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Now all torches share the code. If
you need to update their behavior, edit the template�s script and re-copy it to
others (manually) or have a development cycle to respawn them. If this is
frequent, you can design objects to fetch logic from global each time (e.g.,
each onPickup could call a global function that implements the actual logic, so
if logic changes you only update global).
</span></span></p>

<p><span><span><span>For
something like <b>player character sheets</b>, you might make one and clone for
each player, differentiating by labeling them with the player�s name. The
script on the sheet can then detect its name or attached data to know which
character it is, or even better, doesn�t need to � if each player board is
separate and only that player interacts with it, they all run the same code for
rolls, just using different data (perhaps stored on the board via some state,
like variables in the script or the board�s JSON).</span></span></span></p>

<p><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><b>Avoiding copy-paste in UI
scripts:</b> If you have repeating UI sections for each
player (like Heritage�s repeated clan reference panels), consider generating
those via script instead of writing in XML multiple times. For instance, you
could programmatically add UI for each player color in a loop. However, TTS UI
API lacks a straightforward �create element� function � you normally define XML
upfront. There is
</span></span>UI.setXml(xmlString) which replaces the
entire UI, so you could compute a single XML string that contains repeated
sections for each player by concatenating templates. The repo likely hard-coded
because that was simpler. In modern workflow, if duplication in UI is small and
not likely to change often, it�s acceptable to copy it in XML (with careful
find-replace for IDs). If you foresee a pattern (like 7 virtues and you want
identical UI for each), generating via code might be worth it.</p>

<p><span><span><b>Recommended
modern workflow summary:</b> Use a modular file structure
and an external editing pipeline to sync with TTS (to skip manual bundling).
Write shared logic once, either in shared libraries or global functions, and
have multiple objects call into that rather than each implementing it. Use
object cloning to your advantage � especially for any component that repeats
(player boards, tokens, generic props). Manage these either by spawning at
runtime or by maintaining template objects in a known state that you duplicate
as needed. By doing so, you ensure that updates propagate � e.g., if your NPC
script has a bug, you fix the template and respawn or update all NPCs together
instead of editing each.</span></span></p>

<p><span><span><span>Finally, <b>source
control and backup</b>: Keep your project files under version control (Git) as
you develop. The repo we analyzed is exactly that, which saved the author from
losing work and helps in understanding it now. You can even automate pushing
updates to the game using TTS�s HTTP API (there�s a endpoint to upload a script
to an open game), but that�s an advanced nice-to-have. At minimum, structure
and version your code outside TTS, then import it for testing � this prevents
the nightmare of �code only lives in the game�.</span></span></span></p>

<p>&lt;a
name=&quot;utility-functions-index&quot;&gt;&lt;/a&gt;</p>

<h2><a name="Xe7efa20edc39397ea340fd4253162f258f7cc73"></a></h2>

<p>The
repository contains a robust toolkit of utility functions, both in the
dedicated lib/utilities.ttslua and sprinkled across
modules. We will index notable reusable functions and patterns by domain, note
where they live, what they do, and how to extract them into a new module�s
library. (Functions are referred to with their name as in code, and citations
point to their definitions or usage for reference.)</p>

<h3><a name="Xd998bd8914e4578d0e0cbd2cf5571106ff2e234"></a></h3>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><code><b>U.map(table, func)</b></span><b> / </b></span></span><span><span><code><b>U.filter(table, func)</b></span><b> / </b></span></span><span><span><code><b>U.forEach(table, func)</b> � <b>Observed
in repo:</b> Defined in </span></span></span></span>lib/utilities.ttslua. These are
functional programming helpers for tables. For example, U.map returns a new table by applying func to each element, U.filter returns only elements where func returns true<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L914-L922">[210]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L915-L919">[211]</a>, and
U.forEach just executes func for side effects (used often for
iterating lists of objects or zones)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L607-L615">[212]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L723-L731">[213]</a><span><span><span><span>. <b>Depends on:</b> no
external dependencies, though they likely
use </span></span></span><span><span>U.Type<span> internally to check table type
(ensuring input is a Lua table vs TTS List). <b>Extraction:</b> These can
be copied as-is into your </span></span></span></span>util.lua. Just ensure any helper they
rely on (like U.Type or U.clone) is also included. In the
repo, they�re fundamental and self-contained.</li>
<li><span><span><span><code><b>U.find(table, predicate)</b></span> � Returns
the first element for which predicate returns true. Used, for instance, to
find an object with a certain GUID in a list</span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L103-L111">[214]</a><span><span><span><span> or a tag in a list of tags.
<b>Location:</b> utilities.ttslua. <b>Depends
on:</b> </span></span></span><span><span>U.forEach<span> or similar (could be
implemented with for-loop easily). <b>Extraction:</b> straightforward
copy.</span></span></span></span></li>
<li><span><span><span><code><b>U.Type(obj)</b> � Enhanced type
checker. <b>Observed:</b> In utilities, they use </span></span></span></span>U.Type(x) instead of Lua�s type() to distinguish TTS Userdata
types (e.g., it might return &quot;Object&quot; for a TTS Object,
&quot;table&quot; for Lua tables, etc.)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L906-L915">[215]</a><span><span><span><span>. This is useful when your
functions need to accept either an
object or GUID or a table. <b>Depends:</b> likely checks </span></span></span><span><span>obj.tag<span> or something for TTS objects,
or uses pcall on methods. <b>Extraction:</b> Include it if you plan to
handle mixed types gracefully. Not strictly necessary if you know what
types you pass, but good to have.</span></span></span></span></li>
<li><span><span><span><code><b>U.clone(table)</b> � Deep copy of a
table (to avoid modifying original). <b>Observed usage:</b> Cloning data
structures (like making independent light mode tables in </span></span></span></span>L.SetLightMode before modifying them<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L654-L658">[216]</a><span><span><span><span>). <b>Depends:</b> likely on
</span></span></span><span><span>U.Type<span> to properly clone vectors vs
tables. <b>Extraction:</b> bring it along, as deep copy is often needed
(Lua tables are reference types). Alternatively, one could use a simpler
copy for shallow, but their </span></span></span></span>U.clone is presumably robust.</li>
<li><span><span><span><code><b>U.round(number, [decimals])</b></span><b> and
</b></span></span><span><span><code><b>U.roundVector(vec, sigDigits)</b> �
Rounds numbers to given precision. <b>Observed:</b> e.g., used when
comparing snap point coordinates in zone logic (they round positions to
avoid float quirks)</span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L70-L78">[107]</a><span><span><span><span>. <b>Location:</b>
utilities.ttslua (the snippet shows </span></span></span></span>U.roundVector using U.round on each component<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1056-L1064">[217]</a><span><span><span><span>). <b>Extraction:</b> These
are independent (just math), safe to
use. Good for ensuring consistency in coordinate calculations.</span></span></span></span></li>
<li><span><span><span><b>Random
helpers:</b> </span></span></span>U.randBetween(min, max) probably
returns a random float in [min, max], <span><span><span>U.shuffle(table)<span> shuffles list
in-place, etc. <b>Observed:</b> </span></span></span></span>U.shuffle used to randomize a list
(like houses list in KD UI sim click<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L206-L214">[218]</a><span><span><span><span>). <b>Extraction:</b> If
present, include them � random and
shuffle are common needs (dice rolls, random NPC selection, etc.). They
likely use </span></span></span></span>math.random.</li>
</ul>

<h3><a name="time-and-sequence-utilities"></a></h3>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><code><b>U.waitUntil(afterFunction,
testRef, [isForcing=false], [maxWait=1000], [frequency=15])</b> �
<b>Observed:</b> Defined in </span></span></span></span>utilities.ttslua<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L896-L905">[219]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L927-L935">[220]</a>. This is a
powerful coroutine-based utility that waits until a condition is met, then
executes afterFunction. It can
take a testRef that�s a
function, number, object, or table of those, and it
internally checks if the condition is satisfied (the code builds a CheckCoroutine that
yields until done)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L927-L935">[220]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L929-L938">[221]</a>. For
example, U.waitUntil(fn,
5) waits 5 seconds then calls fn, or U.waitUntil(fn,
obj) waits until <span><span><span>obj.resting<span> is true
(object has settled). <b>Depends on:</b> The coroutine
environment of TTS (they call </span></span></span></span>startLuaCoroutine(self,
&quot;CheckCoroutine&quot;) inside)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L956-L961">[222]</a>, and it
uses coroutine.yield(0) to
wait frames. Also relies on U.Type to parse
different testRef types (as seen: it treats numbers as
seconds, objects as waiting for rest<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L908-L916">[223]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L912-L919">[224]</a><span><span><span><span>, tables as
multiple conditions aggregated). <b>Extraction:</b> This is one of the
most beneficial utilities to carry over. It does low-level coroutine
management for you. To extract, copy the function and the supporting </span></span></span></span>CheckCoroutine logic.
Ensure you also bring any global variables it uses (like
if it uses a self context or
references to frameCount etc., likely
self is passed from the context it�s called in; in
global, self is Global itself).
The repo�s implementation is tied to being
within an object script because they call startLuaCoroutine(self,
&quot;...&quot;). In Global context, self refers to Global.
If you put U.waitUntil in Global
(utilities loaded in Global), you might need to adjust
to call startLuaCoroutine(Global,
&quot;...&quot;) or similar. The simplest way:
integrate it as a method within Global context � in KD they likely call
U.waitUntil from Global
and inside it uses startLuaCoroutine(self,
...) with self=Global (since U is required in
Global). That should work. Test after porting.</li>
<li><span><span><span><code><b>U.RunSequence(funcList,
[maxWait], [frequency])</b> � Automates
running a series of functions sequentially, where each function can
specify when the next should run. <b>Observed:</b> Defined in utilities</span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L961-L969">[225]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L970-L978">[226]</a> with
example usage commented<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L995-L1003">[227]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1004-L1012">[228]</a>.
Essentially, it iterates through a list of functions: executes one,
captures its return, and uses U.waitUntil to wait
until the condition implied by the return is met before
calling the next. The return can be a number (delay seconds), an object
(wait until resting), a function (poll until it returns true), or table of
those � as described in their comments<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1026-L1034">[229]</a><span><span><span><span>. <b>Depends
on:</b> </span></span></span></span>U.waitUntil (it calls
it internally)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L970-L978">[226]</a>. Also uses
U.shift to pop the next
func from list (they likely defined <span><span><span>U.shift<span> to remove first
element). <b>Extraction:</b> Must include </span></span></span></span>U.waitUntil as well.
This is extremely useful for orchestrating multi-step
processes (like scene transitions: fade lights -&gt; wait -&gt; display
text -&gt; wait -&gt; play sound). The repo used it heavily for timed
sequences. Copy it into your util.</li>
<li><span><span><span><code><b>U.sequence(funcList,
timeDelay)</b></span> � Simpler scheduler using
</span></span><span><span>Wait.time<span>.
<b>Observed:</b> Defined in utilities</span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1035-L1043">[230]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1044-L1053">[231]</a>. It just
schedules each function in order with a fixed delay or specified delays
(if an element is a number, it adds that as extra delay). They used this
in KD onLoad to perform a few
actions with 0.5s spacing<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L350-L359">[70]</a><span><span><span><span>. <b>Depends:</b>
</span></span></span></span>Wait.time (TTS global)
and <span><span><span>U.Type<span>.
<b>Extraction:</b> Easy to include. Good when you don�t need
complex conditions, just a fixed interval between calls. Could rename it
to avoid confusion with RunSequence (maybe call it delaySequence). But
since you have the code, use it for quick staggered executions (like show
UI then 2s later hide it, etc.).</span></span></span></span></li>
<li><span><span><span><code><b>U.Lerp(setFunc,
startVal, endVal, duration, isRotation, easing)</b></span> � Performs
interpolation over time between start and end value by
repeatedly calling </span></span><span><span>setFunc(value)<span> as time
progresses. <b>Observed in repo:</b> Defined in utilities</span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1066-L1074">[232]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1092-L1100">[233]</a>. They
handle both Vectors/Colors and numbers, and have an optional easing
(&quot;speedUp&quot; squares the t for acceleration)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1094-L1102">[234]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1098-L1105">[235]</a>. They even
adjust rotation interpolation to take shortest path (adding/subtracting
360)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1074-L1082">[236]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1080-L1089">[237]</a>. It runs
as a coroutine using coroutine.yield(0)
until done<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1108-L1114">[238]</a>, meaning
you must call it within a startLuaCoroutine
context or within their RunSequence (which itself yields). In
repo, they use U.Lerp inside
U.RunSequence by
returning it from a function � see lerpFuncs being
collected and returned in L.activateLight<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L680-L688">[193]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L690-L698">[239]</a>. Actually
they do table.insert(lerpFuncs,
U.Lerp(...)) for each property, then return
that list in a function to RunSequence, which will wait until all of them
complete (since a table testRef waits for all inside to complete)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L913-L921">[240]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L915-L919">[211]</a><span><span><span><span>. This is
clever: it allows parallel interpolation of multiple properties. <b>Depends
on:</b> uses </span></span></span></span>os.time() for timing
(could use Time.time but probably
os.time in TTS gives game time). Also likely needs <span><span><span>startLuaCoroutine<span> like
others. <b>Extraction:</b> This function is gold for smooth
animations. Include it and ensure to call it properly. If used standalone,
you�d do something like </span></span></span></span>startLuaCoroutine(Global,
&quot;LerpCoroutineName&quot;) where inside
that coroutine function you call U.Lerp and yield it. But easier is to use
it within RunSequence or a small wrapper. In any case, bring it (and any
piece of os usage is fine in TTS
since os.time() is
allowed).</li>
</ul>

<h3><a name="ui-and-player-utilities"></a></h3>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><b>UI helpers:</b> The repo largely manipulates UI via direct
calls rather than having
specific util functions for building UI (except toggleXmlElement in KD HUD).
However:
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><code><b>toggleXmlElement(elemID,
button)</b> � <b>Observed:</b> in KD hud</span>
</span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L181-L190">[20]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L192-L200">[21]</a>. It�s a small
helper to collapse/expand UI sections. It checks current UI.getAttribute(elemID,
&quot;active&quot;), sets it true/false
accordingly, hides another element if needed (they hide splashScreen when debug
panel opens)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L184-L192">[241]</a>, and flips the
toggle button�s text between �&#9660;� and �&#9658;�<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L190-L198">[242]</a><span><span><span><span>. <b>Extraction:</b>
If you plan on similar collapsible UI sections, you can copy this. It depends
only on UI and the naming scheme that the toggle button�s id is
&quot;toggleElem_&lt;PanelID&gt;&quot;. Adapt as needed.</span></span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><code><b>UI.setAttributes(id,
{prop=val,...})</b></span> vs individual
setAttribute: The repo wrote their own </span></span></span>UI.setAttributes likely
as a convenience to set multiple at once<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L163-L171">[243]</a>. This is not a
default API (TTS has UI.setAttribute for one
at a time). Possibly they implemented UI.setAttributes in
util or extended UI via console require. If not an API, they
might have a custom function wrapping multiple calls. In practice, TTS now
has UI.setAttributes(elementID,
tableOfAttributes) as an actual function
(looking at the context, it might � or it�s their addition). The snippet<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L163-L171">[243]</a> shows UI.setAttributes(&quot;debug_testFunc&quot;..count,
{ text=&quot;T: Name&quot;, colors=&quot;...|...|...&quot; }). There isn�t
an official <span><span><span>setAttributes<span> in TTS
docs (only setAttribute), so I suspect they monkey-patched
the UI table or used the VS Code extension that adds that. <b>Recommendation:</b>
If not available by default, you can create your own util:</span></span></span></span></li>
</ul>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>function UI.setAttributes(elementID, attrs)<span><br>
</span>
</span></span><span><span>� for k,v in
pairs(attrs) do<span><br>
</span></span></span><span><span>����
UI.setAttribute(elementID, k, v)<span><br>
</span></span></span><span><span>�
end<span><br>
</span></span></span></span>end</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>Then you can use it like in the repo. It�s small but handy.
</span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><b>Player and
permission utils:</b></span></span></span></li>
</ul>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><b>Promote all players</b> � In Heritage,
</span></span></span>onPlayerConnect does
player.promoted =
true<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L440-L448">[83]</a>. This is
effectively a one-liner util (no function needed, just know you can do it). If
you want a util, you could have U.autoPromoteAll() that
registers onPlayerConnect as in repo.</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><b>Camera control:</b> The KD
</span></span></span>players module has
P.SetCamera(mode,
targetColor, viewer) presumably. We see calls like
P.SetCamera(&quot;BehindScreen&quot;,
pColor, &quot;Brown&quot;) to set a specific angle
for a player or for the Brown player to view something<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L64-L67">[9]</a>. They likely stored
predefined camera transforms in C (like C.CameraAngles.BehindScreen). That function probably calls Player[playerColor].setCameraMode() or uses Player[playerColor].lookAt(position). This is a nice utility if you want cinematic camera moves. If P.SetCamera exists in
repo, consider adapting it. It likely depends on constants
(for positions) and uses Player API.</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><b>Color conversion:</b> They had a
</span></span></span>stringColorToRGB in
console commented code<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L29-L37">[244]</a>. Possibly a util to
get a Color from a string name. TTS has a built-in Color.fromString(&quot;Pink&quot;). If they wrote one, you can skip it and use built-in.</p>

<h3><a name="game-specific-patterns-state-zone-etc."></a></h3>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><b>State saving
pattern:</b> They maintain </span></span></span>gameState as a Lua table and use JSON
encode/decode on it for onSave/onLoad<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L52-L55">[8]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L302-L310">[66]</a>. They also provide helpers:
S.setStateVal(value, key1, key2, ...)
and S.getStateVal(key1, key2, ...) to set
nested values in that state. For example, KD�s lighting uses S.setStateVal(mode, &quot;lights&quot;, lightName)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L644-L651">[29]</a> to record the mode of a
particular light under <span><span><span>gameState.lights[lightName]<span>. That is
likely implemented in state.ttslua. <b>Extraction:</b> It�s highly
reusable to have a couple of functions to manipulate nested state without
worrying if intermediate tables exist. If not provided in repo explicitly,
easy to write:</span></span></span></span></li>
</ul>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>function S.setStateVal(val, ...)<span><br>
</span>
</span></span><span><span>� local keys = {...}<span><br>
</span></span></span><span><span>� local t = gameState<span><br>
</span></span></span><span><span>� for i=1, #keys-1 do<span><br>
</span></span></span><span><span>��� local k = keys[i]<span><br>
</span></span></span><span><span>��� if t[k] == nil then t[k] = {}
end<span><br>
</span></span></span><span><span>��� t = t[k]<span><br>
</span></span></span><span><span>� end<span><br>
</span></span></span><span><span>� t[keys[#keys]] = val<span><br>
</span></span></span><span><span>end<span><br>
</span></span></span><span><span>function S.getStateVal(...)<span><br>
</span></span></span><span><span>� local keys = {...}<span><br>
</span></span></span><span><span>� local t = gameState<span><br>
</span></span></span><span><span>� for i,k in ipairs(keys) do<span><br>
</span></span></span><span><span>��� if t == nil then return nil
end<span><br>
</span></span></span><span><span>��� t = t[k]<span><br>
</span></span></span><span><span>� end<span><br>
</span></span></span><span><span>� return t<span><br>
</span></span></span></span>end</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>This mirrors what the repo likely has. It depends only on
</span></span></span>gameState table. Extract or implement for
your mod � it will simplify updating and reading deep state (like S.setStateVal(true, &quot;players&quot;, playerColor,
&quot;hasBook&quot;) to mark a player property).
</p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><b>Logging and
debugging:</b></span></span></span></li>
</ul>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><code><b>U.Alert(message)</b></span><b>
and </b>
</span></span><span><span><code><b>U.AlertGM(message)</b></span> � Observed via calls
like </span></span></span>U.AlertGM(&quot;Coroutine Timeout: Forcing ResultFunc&quot;) in
waitUntil<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L932-L940">[245]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L934-L939">[246]</a>.
Likely, U.AlertGM prints a message only to the GM
(maybe via printToColor or so), whereas U.Alert might broadcast to all or print in
chat with formatting. Could also be alias to TTS broadcastToAll or <span><span><span>print()<span>. <b>Extraction:</b> If present,
they are easy to bring. At least a custom print that prefixes �[ModName]: ...�
can be helpful for debugging.</span></span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><code><b>U.Assert(context, value, expectedType, errorMsg, {isThrowing})</b></span> � Observed
usage in lighting: </span></span></span>U.Val(&quot;setLightMode&quot;, lightName, condition, &quot;Mode
Data Not Found&quot;)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L624-L632">[247]</a> � Actually
U.Val might be their assertion,
ensuring conditions hold, and either throwing error or just printing.
Possibly U.Val and U.Assert do similar checks. If they
wrote these, they help catch mistakes. For example, <span><span><span>U.Assert(&quot;functionName&quot;, param, &quot;Object&quot;,
&quot;not an object&quot;)<span> might check type
and either error or just log. <b>Extraction:</b> These depend on how you
prefer to handle errors. If you want robust error checking, include them.
If not, you can skip or simplify (TTS prints errors anyway if something is
nil and used incorrectly).</span></span></span></span></li>
<li><span><span><span><b>Zone and object
helpers:</b></span></span></span></li>
</ul>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><code><b>U.isInside(zone,
worldPosition)</b></span> � Possibly to check if a point
is within a zone�s bounds. They did something similar in
</span></span></span>Z.getSnapPointsInZone by taking each snap
point world position and checking U.isInside(zone, pos)<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L104-L111">[248]</a>.
If they have an isInside util, include it (likely uses
zone�s bounding box).</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><code><b>Z.getTaggedZoneObjects(zone,
tags)</b></span> � Possibly returns all objects in a zone
that have any of a set of tags. Not explicitly shown, but they have things like

</span></span></span>Z.writePosToTaggedObjectsInZone(zone, tags, mode, stateKey, subKey) which finds
objects with given tags in zone and writes their positions
to their description or to gameState<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L160-L168">[249]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L164-L170">[250]</a>.
That presumably uses a helper to get those objects. If provided, it�s quite
useful: in VTM5E, you might have zones for �items on ground� or similar and
need to fetch all relevant objects.</p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><code><b>Z.activateZones()</b></span><b> and </b></span></span><span><span><code><b>Z.deactivateZones()</b></span> � They call
Global�s functions to assign or remove </span></span></span>onObjectEnterZone handlers<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L115-L123">[109]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L121-L129">[251]</a>. This pattern is useful if
you need to toggle triggers (perhaps
to pause the game or during cleanup). They already implement it; you can
reuse by adjusting it to your needs. It depends on having your zone event
functions set in Z.</li>
<li><span><span><span><b>Coroutines for parallel
tasks:</b> The repo
pattern worth noting: inside </span></span></span>L.SetLightMode, they wanted to animate
multiple light properties at once. They collected multiple U.Lerp calls in a table and returned
that table in a function to RunSequence<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L680-L688">[193]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L690-L698">[239]</a>. Their
U.waitUntil recognizes a table testRef
as �wait until all contained have finished�<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L912-L919">[224]</a><span><span><span><span>. This is an advanced utility
pattern enabling <b>parallel
execution</b>. So if you extract </span></span></span></span>U.waitUntil and U.RunSequence, you automatically gain
the ability to do parallel tasks by returning a table of wait conditions.
This can be used for other things too (e.g., waiting for multiple players
to press ready: you could initiate a waitUntil that checks all players
have clicked, using a table of booleans for each). Keep this in mind; it�s
not a separate function but a pattern of usage with the provided utils.</li>
</ul>

<p><span><span><span><span>Now,
with the above inventory, here�s a <b>proposed </b></span></span></span><span><span><code><b>lib/</b></span><b> layout for a new VTM5E module</b> (picking out the
most reusable pieces):</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><code><b>lib/util.ttslua</b></span><b>:</b> Contains general-purpose utilities:
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Table ops: map, filter, find,
shuffle.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Math: round, clamp, randomBetween.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Type: Type checking, clone.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Timer/Sequence: waitUntil,
RunSequence, sequence (timed), maybe simple delay function.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Lerp and any easing utilities.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Debug: Assert, Alert, print
helpers.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Possibly UI.setAttributes
convenience.
</span></span></span></p>

<p><span><span><span><span>Essentially,
everything under <i>General Utilities</i> and <i>Time and Sequence Utilities</i>
above goes here as functions on a table U (which you then require as needed).
This file becomes analogous to the repo�s </span></span></span></span>lib.utilities.</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><code><b>lib/constants.ttslua</b></span><b>:</b> Define constants for game values:
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>If there are fixed clans,
disciplines, hunger levels, etc., list them here.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Colors mapping (e.g., a map of
</span></span></span>StorytellerColor = &quot;Brown&quot; if you
decide Brown is GM, etc.).</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Perhaps define preset camera
angles or zone positions if you plan to use them often.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>Light preset configurations could
live here too (like how KD had Light mode definitions in lighting module; you
can put basic constants like default intensities in constants to tweak easily).
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>If any UI element needs static
text repeated or asset names, define here for consistency.
</span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li>Essentially, anything
�tunable� or static data, isolate in
constants so you don�t sprinkle numbers/strings all over logic.</li>
<li><span><span><span><code><b>lib/scene.ttslua</b></span><b>:</b> (Optional) If you abstract
the scene presets logic, you might put
configuration and some helper functions here. For example, a table of
scene presets and a function </span></span></span>applyScene(name) that uses Lighting and MusicPlayer calls to set the ambiance.
This could also house functions to play certain sound effects or gradually
change lighting (using U.Lerp from util). It�s partly game-specific but
also an abstraction over direct API calls � grouping them means less
repeated code when switching scenes.</li>
<li><span><span><span><code><b>lib/state.ttslua</b></span><b>:</b> Instead of mixing state
functions into core, you can have a small
library solely for saving/loading and accessing state (like the S module).
It can hold the </span></span></span>gameState table (or you can keep
gameState global and just have functions in state lib that operate on it).
Functions:</li>
</ul>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>init(defaultState) � sets
gameState to a default or merges missing defaults (ensuring all keys exist).
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>getVal / setVal � as discussed.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]>maybe utility to compute derived
state if any (like currentTurn = (some calculation), but those can be in core
too).
</span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li>In Heritage, S was part of
core, but separating it keeps core
cleaner. Up to you.</li>
<li><span><span><span><code><b>lib/logging.ttslua</b></span><b>:</b> If you plan extensive
logging or using Notebook, you could
separate that. e.g., functions to add a line to the session log, or to
output the recap at session end to a notepad. The repo didn�t have such a
separate module, they integrated logging in util (AlertGM etc.). Unless
your logging logic is complex, you might keep it in util as well.</span></span></span></li>
</ul>

<p><span><span><span><span>By
structuring the lib this way, your <b>core modules</b> (like core/npc, core/combat,
etc.) can use these libs freely: require them at top to get U, C, State, etc.
Then your object scripts can also require maybe the util (though note: TTS
doesn�t natively allow requiring from object scripts unless you inject that
require function everywhere). Since the repo�s require system seems
global-only, object scripts in TTS typically can�t directly require a module
defined in Global. But in the development environment with their custom loader,
maybe they did allow it. If not, an object script might not be able to </span></span></span></span>require(&quot;lib.util&quot;) at runtime,
because require is not standard. They might have simply had each object script
also include the code from util by the build process. If you use the external
editor syncing, likely you can simulate require in objects too. Alternatively,
for safety, you might not rely on require in object scripts; instead either
global functions or duplicate a tiny needed piece.</p>

<p>For example, if an object script only needs one function from util, you
might just copy that one into it to avoid complexity. Or set _G.U = U in global and call Global.U.whatever from object (or global
call pattern as mentioned).</p>

<p><span><span><span><b>Conclusion:</b> The toolkit in the repo is quite
comprehensive � you�ll want to incorporate the majority of it in your new module�s
library. This will accelerate development since you can rely on tested
functions for asynchronous flows, table manipulation, etc. Just make sure to
test these utilities in isolation when you port them, to ensure nothing in them
is referencing non-existent global state. For instance, </span></span></span>startLuaCoroutine(self, ...) calls might
need adjustment if self isn�t defined the same way; you could
refactor those to always use Global or a passed object reference.</p>

<p>By extracting and using this toolkit, your VTM5E mod code can focus on
game logic (the �what�) and rely on the utility layer for the �how� (e.g.,
smoothly move this object, wait for that event, update UI text, etc.), making
the code more maintainable and avoiding reinventing wheels.</p>

<p>&lt;a name=&quot;new-vtm5e-module-blueprint&quot;&gt;&lt;/a&gt;</p>

<h2><a name="new-vtm5e-module-blueprint"></a></h2>

<p><span><span><span>Designing a <b>VTM5E
Storyteller module</b> in TTS means focusing on tools that enhance an RPG
session: providing visual aids, automating dice mechanics, tracking secret
info, and setting the scene � all while keeping players immersed and the
Storyteller in control. Based on lessons from the repo and TTS capabilities,
here�s a blueprint of key components and how to leverage them:</span></span></span></p>

<h3><a name="storyteller-control-surface-gm-dashboard"></a></h3>

<p><span><span><span><b>Observed in
repo:</b> King�s Dilemma had an admin
panel for the host with phase controls</span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L23-L31">[26]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L32-L40">[252]</a>,
and Heritage had a GM sidebar with many reference toggles<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L66-L74">[148]</a><span><span><span><span>.
For VTM5E, the GM�s needs include scene management, NPC oversight, and
narrative pacing. We propose a <b>GM Control Panel UI</b>, possibly as a tablet
or a side screen object for the GM, with the following features: - <b>Scene
Presets:</b> A set of buttons or a dropdown to activate predefined scene
ambiance (as discussed in section 3). This ties into the <b>scene system</b>:
e.g., �Elysium�, �Street Chase�, �Haven�, �Downtown Nightclub�. When the GM
triggers one, the script will adjust lighting, background, and music
accordingly, and perhaps pop up a short description for players. The UI could
be a simple panel listing scenes. <i>Implementation:</i> Use </span></span></span></span>UI.Button elements for each scene, calling <span><span><span>Global/Scene_set(name)<span>. Highlight the
active one (e.g., by changing its color). - <b>NPC Tracker:</b> Running
multiple NPCs in an RPG can be aided by having their stats and status at a
glance. This could be a UI window that only the GM sees (visibility GM). It
might list each notable NPC with fields like Health, Willpower, a brief note,
and maybe a �reveal to players� toggle. For example, a small panel per NPC with
their name and some checkboxes or counters. If an NPC enters the scene, the GM
can tick a �Visible� box which could, for instance, spawn a token on the board
or show an image to players. <i>Implementation:</i> This could be an HTML-like
UI list that the GM can expand/collapse. Or, use in-world objects: e.g., have
NPC figurines on a GM-only board that show status bars through state (less
ideal since players can�t see them). A UI approach is likely cleaner for
overview. For automation: you might maintain an NPC table in state and update
UI accordingly. - Additionally, include quick buttons like �Blood Surge� or
�Rouse Check� next to each NPC to automate those rolls (the result could be
printed to GM or applied to NPC�s hunger if it�s a vampire). - <b>Quick Dice
Tools:</b> Even the GM may want shortcuts: e.g., a �Roll for all players a
Hunger frenzy� � that�s niche. More practically, a <b>dice roller interface</b>
where the GM can input a dice pool (like 6 dice, 2 hunger) and roll, with
results shown to either GM only or everyone, as appropriate. Perhaps the GM
panel has a mini form: two number inputs (regular dice, hunger dice) and a
�Roll!� button. <i>Implementation:</i> This calls a dice-rolling function that
creates and rolls dice objects or simulates the roll and outputs the result (calculating
successes, messy criticals, etc.). TTS can simulate dice physically, but for
many dice, a script calculation might be faster and clearer in chat (e.g.,
�Rolled 4 successes (1 crit), 1 hunger fail� printed). - <b>Handouts and
Images:</b> The GM often shares images (NPC portraits, clues) or text notes.
The Heritage mod�s reference toggles are analogous to handouts � clicking
showed an image for players</span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L72-L80">[129]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L32-L40">[253]</a><span><span><span><span>.
For VTM5E, design a <b>Handout Viewer</b>: the GM control can have a dropdown
of prepared handouts (images of clues, lore, etc.). Selecting one either spawns
a tablet object that displays that image to players or uses UI to show it.
Simpler: use UI�like Heritage�s reference images which appear for players when
toggled</span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L32-L40">[253]</a><span><span><span><span>.
So, the GM panel might have �Show Handout: [list of titles] (Show to All / Show
to Player X)� � choosing a handout and clicking shows an image panel to the
relevant audience. <i>Implementation:</i> You can pre-load images in your mod
and reference them by asset name in UI (like Heritage uses </span></span></span></span>image=&quot;ref-ancillaeA&quot; for an
asset named in workshop files). Then <span><span><span>UI.show(&quot;RefAncillaeARed&quot;)<span>
similar to how they did. Or spawn a custom tile object with that image, but UI
is easier for full-screen images. - <b>Session Controls:</b> Things like a <b>Break
Timer</b> � the GM hits �Break 5 min�, it displays a countdown on everyone�s
screen (�Break: 04:59�) and perhaps dims lights (fun effect) until time�s up.
The GM panel can have preset durations (5, 10, 15) and a start button. <i>Implementation:</i>
Use </span></span></span></span>Wait.time in a loop to update a UI text
element every second. At 0, maybe play a sound or flash UI. This isn�t in the
repo explicitly, but it�s straightforward with the util functions you have
(maybe use <span><span><span>U.sequence<span>). - <b>Content Safety Flags:</b>
This is sensitive but important for some groups � a quick way for players to
signal discomfort (like an X-Card). Usually players have control of that (e.g.,
a big X button on their UI that when pressed, shows an X symbol to all or
notifies GM). But the GM panel could have a toggle like �Safety On/Off� to
enable those tools (if group uses them). Not a core feature, but mention
because user did. - <b>Recap/Note Capture:</b> The GM interface might include a
�Start Session� and �End Session� button. On Start, perhaps create a new
Notebook entry with session date. On End, auto-gather some info: you could take
the chat log or key events recorded in state and dump them to the Notebook as
recap. Or simply prompt the GM to write a quick recap in a text input and then
save it. This is more speculative � the repo doesn�t have it, but a �session
journal� in the mod could be cool. TTS�s Notebook can be manipulated via script
(</span></span></span></span>Notes.setNotes etc.). Possibly when End
Session is clicked, the module could compile: �Dilemmas resolved: X, Y, Z� or
�XP to award: ...� etc. It depends on how much you automate.</p>

<h3><a name="player-ux-character-player-tools"></a></h3>

<p><span><span><span><span>Each player should have a <b>Character
Panel</b> and streamlined tools
for common actions: - <b>Character Sheet Panel:</b> TTS won�t replace your
detailed character sheets, but a simplified HUD can track current values that
change frequently (Hunger, Willpower, Health, Humanity, etc.). For example, a
small UI on each player�s screen (visibility to that player, plus GM) showing a
row of Hunger dots, Willpower dots, etc., that they can click to toggle
filled/unfilled. This gives a quick visual of important stats. <i>Implementation:</i>
An XML for each player color, similar to how Heritage did clan reference
panels</span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L132-L140">[254]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L134-L142">[255]</a>. It could
present interactive elements: e.g., hunger � 5 blood drop icons, of which some
are filled red depending on hunger. The player can click + or � to change
hunger (firing a <span><span><span>HUD_hungerUp<span> event to global which
increments their hunger in state and updates UI for that player). Or just
toggle icons directly with onClick on each icon (but easier to centralize
logic). The GM can also see these, so they know each player�s state at a glance
(the GM UI could even aggregate them). - <b>Dice Roller Macro:</b> Instead of
each player manually handling dice objects, provide buttons for common rolls: -
Standard roll: The player inputs (or selects via dropdowns) Attribute + Skill,
the script knows their Hunger value from their character sheet, and then rolls
accordingly. Perhaps the UI shows something like �Strength (4) + Brawl (3)
[Roll]� as a button � which the player presses, and the mod does: roll 7 dice
with hunger dice = current hunger. The result can output to chat �&lt;Name&gt;
rolled 3 successes (Critical Win!)� or even spawn actual dice objects that physically
roll (but that�s slower and can be chaotic to read). - Rouse Check: a one-die
roll for blood power usage � simply a button that automatically rolls 1 die
(hunger doesn�t matter for Rouse) and outputs success/failure. The mod can even
automatically adjust Hunger up if failed (since it tracks hunger). - Feeding
(hunting) macro: if you want, could automate an extended test for hunting based
on difficulty. But focusing: The dice roller for players is a key convenience. <i>Implementation:</i>
Provide a small UI list of their disciplines/attributes? That might get too
heavy. Perhaps simpler: let them type the pool size. But we can do better given
we have data: If you store their attribute and skill ratings (maybe not all,
that�s a lot of data entry in TTS unless you integrate charsheet), maybe not
worth it. Instead, maybe a �Custom Roll� button where they enter a number for
pool and it uses current hunger. Or a list of generic buttons: e.g., �Roll 3�,
�Roll 5�, �Roll 7� plus always factor hunger. Or let them adjust the number by
small +/� and then press roll. The UX could be like:</span></span></span></span></p>

<p>[ � ] [ Dice Pool: 6 ] [ + ]��
[Roll]</p>

<p><span><span><span><span>and a separate display of hunger which
they control via their sheet. So
they set the pool and hit Roll. The script then calculates successes. (You�ll
need to implement VTM dice rules: each die 6+ is success, 10s count two
successes and if at least two 10s and at least one is hunger 10 then messy
critical, etc., plus bestial failure if a 1 on hunger die when total fails�
It�s manageable in code). - <b>Private Notes / Journal:</b> Players might want
to jot secret notes. TTS Notebook has individual tabs for each player � which
are private by default (players can each see only their own color�s tab unless
GM toggles view). The module could encourage usage of that. Not much to script
there, except maybe moving some content at session end. Alternatively, a
notecard object (like a hidden index card) could store a note if a player puts
it there. But likely overkill � this can be out-of-game or just trust them to
use Notebook.</span></span></span></span></p>

<ul style='margin-top:0cm' type=disc>
<li><span><span><span><b>Handouts
&amp; Visuals (Player side):</b><span> The players will
receive images from GM toggles as above. Maybe also allow them to review
previously shown handouts. Possibly a �Handout Library� UI that lists
images they�ve seen and they can reopen them. This could be a simple UI
with buttons for each unlocked handout (the GM, when showing one, also
flips a state flag to unlocked for players). Then players have a
�References� panel they can open to re-read clues or see NPC portraits
again. <i>Implementation:</i> When GM toggles an image on, add that
image�s ID to a list for that player (or All). Then their UI (if they open
a �References� window) populates with those as clickable items.</span></span></span></span></li>
<li><span><span><span><b>Other
macros:</b> Perhaps �Blood surge� (increase attribute
temporarily, requires a Rouse Check � could chain a Rouse Check roll
automatically and report outcome). Or �Heal one Agg damage� which requires
Rouse � again automate. Essentially, any frequently done mechanical step
can be one-click. These can be added over time as needed.</span></span></span></li>
</ul>

<h3><a name="hidden-information-and-mechanics"></a></h3>

<p><span><span><span><span>VTM has a lot of secrets: hunger dice
effects, whether a character is
secretly a supernatural type, notes between players and GM, etc. The module
should facilitate hiding/revealing info properly: - <b>Private Zones:</b> TTS
allows hand zones visible only to the owner and GM. For example, you could
instruct each player to use their Hand as a place to put cards or notes that
only they and GM see. The mod can spawn a custom card for a secret and deal it
to that player�s hand zone. Only that player and GM will be able to read it (if
you put the text in the card description and set it face-down for others). This
is an analog method using TTS mechanics. The repo uses invisibility: e.g.,
secret agenda cards are invisible to other players</span></span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L109-L117">[13]</a>. You can
do similar: mark objects as invisible to certain players. For instance, if you
have a notecard object with a clue for player A only, do <span><span><span>obj.setInvisibleTo({&quot;B&quot;,
&quot;C&quot;, &quot;D&quot;, ...})<span> to hide from
everyone except A (and GM always sees everything). - <b>Hidden zones on board:</b>
You might designate an area behind each character sheet where only that player
can see. But that�s redundant with Hand zones unless you need a bigger area.
Hand zones are simpler because built-in. - <b>GM-only info:</b> The GM might
have an NPC info board (like behind a DM screen) where they keep tokens
representing ongoing story status (e.g., a tracker for how suspicious the
prince is). That can be just off table or in a hidden zone (there�s a feature
�Hidden� zone in TTS which hides content even from GM unless they explicitly
peek, but that�s more for puzzles). - <b>Controlled Reveals:</b> If you plan an
investigation where the GM slowly reveals parts of an image or map, that gets
complex (like flipping tiles or using fog-of-war). TTS does have Fog of War
which GM can toggle for certain zones. The API for Fog might not be available,
but GM can manually reveal areas. Alternatively, break the map into tiles and
only spawn them when needed. - <b>Dice privacy:</b> When players roll hunger
dice, arguably results should be known to all (the drama of messy criticals
etc.), but if you needed secret rolls, you can roll dice in a hidden zone or
simply output result to GM only. </span></span></span></span>printToColor can send
chat to just one color.</p>

<p><span><span><span><b>Repo
analogies:</b> King�s Dilemma had physical
secret envelopes for each player, which they simulated by dealing secret agenda
cards invisible to others</span></span></span><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L109-L117">[13]</a>. We can
similarly deal �Secret� cards. Heritage had secret clan roles and tokens they
hide until reveal � they locked those objects and made them invisible until a
phase ends<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L101-L109">[256]</a>. This
pattern � create object but obj.setInvisibleTo(players) � is handy. For text, a more direct approach is Player[color].print(&quot;You
notice something strange...&quot;) for a private GM
whisper. TTS has printToColor (GM can whisper a player,
essentially). Use that for quick messages that shouldn�t be seen by others.
</p>

<h3><a name="safety-and-session-pacing-utilities"></a></h3>

<p><span><span><span><span>Beyond core mechanics, a polished
module can include: - <b>Break Timer:</b>
As mentioned, let GM set a timer that�s visible to all. Possibly dims the
screen or displays �BRB � resume at X:XX�. You can do this by overlaying a
full-screen semi-transparent UI panel for all players with a timer text. (A
simple panel with black translucent background and big text in center counting
down.) - <b>Consent/Safety Tools:</b> Provide an �X-Card� button for players �
e.g., a small always-on UI in a corner with an �X� that if clicked, sends an
alert to GM (and maybe changes a UI symbol visible to all, like flashing an �X�
on everyone�s screen so the flow can pause). Alternatively, have a �slow down�
or �skip� signal. These are optional but if the group uses them, integration is
nice. Implementation could be: an </span></span></span></span>onClick=&quot;Safety_X&quot; on a hidden UI
for each player (like a red X icon in a corner). The Safety_X function could do
<span><span><span>broadcastToAll(&quot;[X-Card played] Content skipped&quot;)<span> or just tell GM. This
is more about group norms than code, but it�s
easy to implement if desired (just a button and a print). - <b>Recap capture:</b>
At session end or start of next, it�s great to recap previous events. The
module could help by storing some log � if you design your flows to record
important points (for example, each scene could append a short summary in a log
string, or each major roll outcome could be logged), you could output that to
the Notebook or chat. Even a simple auto-list of XP gained or willpower spent
can help with bookkeeping. Perhaps at End Session, the mod prints: �Session End
� XP earned: 3 each (tentative). Willpower used: Alice(2), Bob(1) � remind ST
to refresh those. Hunger levels: ...�. This requires tracking those during
play, which you will be doing anyway if you maintain hunger, damage etc., in
state.</span></span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<![endif]><b>Pacing reminders:</b> If the ST tends to forget when an hour
passes (for Hunger checks or
scene changes), a subtle timer that pings every in-game hour could be included.
E.g., real-time 60 minutes triggers something (though TTS script can track real
time via Wait, yes). But this might be too much � an ST can handle that
narratively.
</span></span></span></p>

<h3><a name="mvp-first-scope-and-roadmap"></a></h3>

<p><span><span><span><b>Minimum Viable Product (MVP)
features:</b><span> It�s
wise to implement in stages: 1. <b>Basic UI and state tracking:</b> Ensure each
player has a character HUD (even if just hunger and willpower to start) and the
GM has a minimal control (maybe just scene presets and a simple dice roller).
Make sure saving/loading restores the state (persist hunger, health, etc., in
gameState). 2. <b>Dice rolling mechanics:</b> Implement core dice logic for
normal rolls, hunger, rouse, bestial fail, etc., and integrate that with the UI
(players click roll, get result in chat). 3. <b>Lighting &amp; ambiance:</b>
Have at least one or two scene presets working with visible effect (so you can
dramatically press a button to change lights and music � this gives the �wow�
factor and is useful). 4. <b>Secret info handling:</b> Something like dealing a
secret card to a player or sending a private message � test one method of
secret communication so that pipeline is figured out (as this can be critical
in game scenarios). 5. <b>Persistence and turn management:</b> Possibly not as
needed in an RPG (no fixed turn order like board game), but if there are
sequences like a combat tracker, that might come later.</span></span></span></span></p>

<p><span><span><span><b>Roadmap (further
phases):</b><span> - <b>Combat tracker:</b>
If desired, after MVP, implement a turn order tool (players can click an �End
Turn� button or ST can advance turn, highlighting whose turn it is � maybe tie
into camera highlight or a light on that player). - <b>Expanded character
sheet:</b> Add more stats or perhaps allow integration with a web sheet (could
be out of scope, but some mods allow importing data from JSON). - <b>Story
content modules:</b> e.g., pre-loaded NPCs (their stats, portraits) and the
ability to spawn an NPC token on table with a click. This is like building a
little database of NPC info that ST can use mid-game. Could use JSON in
constants or separate files to store NPC templates. - <b>Integration with voice
or other tools:</b> Some STs play background audio externally (you have music
in mod already though). Possibly add a way to signal players to adjust things
(like an on-screen �Volume up� indicator if needed). - <b>Polish UI &amp;
accessibility:</b> e.g., ensure UI works in VR if someone uses that (UI generally
does though). - <b>Documentation for players:</b> Perhaps an in-game �Help�
notecard or UI that explains to players how to use the mod�s features (like
�Press this to roll, press X for safety, etc.�).</span></span></span></span></p>

<p>By implementing in
iterative steps, you ensure the pipeline (saving
state, network sync of UI events, etc.) works before adding complexity.</p>

<p>&lt;a
name=&quot;do-this-next-quickstart&quot;&gt;&lt;/a&gt;</p>

<h2><a name="do-this-next-quickstart"></a></h2>

<p><span><span><span>To kick off
development of the new VTM5E module, here is a <b>minimal checklist</b> and
initial action plan:</span></span></span></p>

<h3><a name="project-setup-checklist"></a></h3>

<p><span><span><span>
<![if !supportLists]>1.&nbsp;&nbsp;&nbsp;

<![endif]><b>Establish Development
Environment:</b><span> Connect TTS to your code editor. <i>(Recommendation:)</i>
Use the VS Code Tabletop Simulator extension (as the repo did) or an
alternative so you can edit multi-file and have require functionality. Ensure
you have your Git repo or file backup ready.</span>
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>2.&nbsp;&nbsp;&nbsp;

<![endif]><b>Repo Structure &amp; Files:</b> Create the folder structure
as planned (e.g.,
</span></span></span>lib/,
core/, ui/). Add placeholder files: global.ttslua (or named
suitably) and core modules (maybe start with just core/state.ttslua and
core/main.ttslua for now), and the utility
lib file. Also prepare an ui.xml for the initial UI
(or you can build it via code, but XML is easier to
visualize for layout).</p>

<p><span><span><span>
<![if !supportLists]>3.&nbsp;&nbsp;&nbsp;

<![endif]><b>Load Basic Script into TTS:</b> Write a minimal
</span></span></span>global.ttslua that,
onLoad, prints a confirmation. For instance:</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>require(&quot;lib.util&quot;)<span><br>
</span>
</span></span><span><span>require(&quot;core.state&quot;)<span><br>
</span></span></span><span><span>function onLoad(saved_data)<span><br>
</span></span></span><span><span>��� print(&quot;--- VTM5E Module
Loaded ---&quot;)<span><br>
</span></span></span><span><span>��� -- Initialize state<span><br>
</span></span></span><span><span>��� S = {}� -- (if you choose to
attach state functions
to a global S table)<span><br>
</span></span></span><span><span>��� S.Initialize = function()
gameState = {} end<span><br>
</span></span></span><span><span>��� S.Initialize()<span><br>
</span></span></span><span><span>���
UI.setXml([[&lt;Panel&gt;&lt;Text text='VTM5E Module
Loaded'/&gt;&lt;/Panel&gt;]])� --
simplistic test UI<span><br>
</span></span></span><span><span>end<span><br>
</span></span></span></span>function onSave() return JSON.encode(gameState) end</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>Load the mod in TTS and ensure you see the message and a basic UI text.
This verifies your require and file linking is working.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>4.&nbsp;&nbsp;&nbsp;

<![endif]><b>Import Utility Functions:</b> Copy over the essential parts
of
</span></span></span>lib.utilities from the
repo into your lib.util. Start with the
basics (map, filter, waitUntil, RunSequence, Lerp) and
test one of them in action. For example, after onLoad, try a small sequence:
</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>U.sequence({<span><br>
</span>
</span></span><span><span>��� function() print(&quot;Hello
World&quot;) end,<span><br>
</span></span></span><span><span>��� 1,<span><br>
</span></span></span><span><span>��� function() print(&quot;1
second later&quot;) end<span><br>
</span></span></span></span>})</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>and see if it prints delayed. This confirms your coroutine system is
functioning.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>5.&nbsp;&nbsp;&nbsp;

<![endif]><b>Set Up Game State:</b> Flesh out
</span></span></span>core/state.ttslua with a proper S module. E.g., define
gameState = {
players = {} } and functions S.setVal and
S.getVal as discussed. Write a quick test:
after Initialize, do S.setVal(5,
&quot;testVal&quot;) then print(S.getVal(&quot;testVal&quot;)) to ensure it stores/retrieves. Also verify that saving and loading
restores gameState (you can simulate by editing save file or printing onLoad
the saved_data decoded).</p>

<p><span><span><span>
<![if !supportLists]>6.&nbsp;&nbsp;&nbsp;

<![endif]><b>Build a Simple UI Element:</b><span> Aim for one functional piece
of UI as a prototype. For instance, a <b>Hunger
counter for one player</b>. Create a UI panel visible to Color Red (assuming
you as ST sit in Red for testing):</span>
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>&lt;Panel id=&quot;charPanelRed&quot; visibility=&quot;Red&quot;
width=&quot;200&quot; height=&quot;50&quot; position=&quot;-300 0 0&quot;
rectAlignment=&quot;UpperRight&quot;&gt;<span><br>
</span>
</span></span><span><span>��� &lt;Button
id=&quot;decHunger_Red&quot; onClick=&quot;Player_HungerDec&quot;
text=&quot;-&quot; /&gt; <span><br>
</span></span></span><span><span>��� &lt;Text
id=&quot;hungerVal_Red&quot; text=&quot;Hunger: 0&quot; /&gt; <span><br>
</span></span></span><span><span>��� &lt;Button
id=&quot;incHunger_Red&quot; onClick=&quot;Player_HungerInc&quot;
text=&quot;+&quot; /&gt;<span><br>
</span></span></span></span>&lt;/Panel&gt;</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>Add this to your UI XML (or assemble via UI functions in onLoad). Then
implement:
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>hunger = { Red=0 }<span><br>
</span>
</span></span><span><span>function Player_HungerInc(player, val, id) <span><br>
</span></span></span><span><span>��� local color = player.color<span><br>
</span></span></span><span><span>��� hunger[color] =
math.min(hunger[color] + 1, 5)<span><br>
</span></span></span><span><span>���
UI.setAttribute(&quot;hungerVal_&quot;..color, &quot;text&quot;,
&quot;Hunger: &quot;..hunger[color])<span><br>
</span></span></span><span><span>end<span><br>
</span></span></span><span><span>function Player_HungerDec(player, val, id)<span><br>
</span></span></span><span><span>��� local color = player.color<span><br>
</span></span></span><span><span>��� hunger[color] = math.max(hunger[color]
- 1, 0)<span><br>
</span></span></span><span><span>���
UI.setAttribute(&quot;hungerVal_&quot;..color, &quot;text&quot;,
&quot;Hunger: &quot;..hunger[color])<span><br>
</span></span></span></span>end</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>Now run two instances of TTS (or have a friend connect) to test that
only Red sees this panel, and the +/� buttons update the text. This gets your
basic player UI loop (button-&gt;callback-&gt;UI update) tested.
</span></span></span></p>

<p><span><span><span>
<![if !supportLists]>7.&nbsp;&nbsp;&nbsp;

<![endif]><b>Dice Roll Test:</b> Without full automation yet, test that
you can spawn or simulate dice.
Perhaps use a simple approach:
</span></span></span>math.random to simulate a
D10 roll. Write a function to roll N dice and count
successes:</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>function rollDice(pool, hunger)<span><br>
</span>
</span></span><span><span>��� local results = { normal =
{}, hunger = {} }<span><br>
</span></span></span><span><span>��� for i=1, pool do<span><br>
</span></span></span><span><span>������� local die =
math.random(1,10)<span><br>
</span></span></span><span><span>������� if i &lt;= hunger then
table.insert(results.hunger, die) else table.insert(results.normal, die) end<span><br>
</span></span></span><span><span>��� end<span><br>
</span></span></span><span><span>��� -- calculate successes:<span><br>
</span></span></span><span><span>��� local successCount = 0<span><br>
</span></span></span><span><span>��� local critCount = 0<span><br>
</span></span></span><span><span>��� for _,d in
ipairs(results.normal) do if d&gt;=6 then successCount = successCount + (d==10
and 2 or 1) if d==10 then critCount = critCount + 1 end end end<span><br>
</span></span></span><span><span>��� for _,d in ipairs(results.hunger)
do if d&gt;=6 then successCount = successCount + (d==10 and 2 or 1) if d==10
then critCount = critCount + 1 end end end<span><br>
</span></span></span><span><span>��� print(&quot;Rolled
&quot;..pool..&quot; (hunger &quot;..hunger..&quot;):
&quot;..successCount..&quot; successes&quot;)<span><br>
</span></span></span></span>end</p>

<p><span><span><span>
<![if !supportLists]>�&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<![endif]>And trigger it somewhere (maybe a temporary button). This is a dry run
for dice logic. Later, you�ll expand it to handle messy/bestial outcomes, but
start simple.
</span></span></span></p>

<p>With these steps, you have a scaffold: state
management working, UI
interactions working, and random rolls working.</p>

<h3><a name="first-3-concrete-features-to-implement"></a></h3>

<p><span><span><span><span>After the basics above, implement
these to validate the pipeline
end-to-end: 1. <b>Hunger &amp; Rouse Check System:</b> Expand the hunger UI so
that when a player increases hunger above 5 (or presses some �Rouse Check�
button), it automatically triggers a Rouse Check roll. For example, add a
�Rouse� button next to hunger; on click, roll 1 die: on success, print �No
increase�, on fail, call </span></span></span><span><span>Player_HungerInc<span> once to increase hunger.
This ties UI -&gt; random roll -&gt; state update -&gt; UI update, covering the
core loop. It also tests private vs public messaging (rouse results could be
printed only to that player and GM). 2. <b>Scene Lighting Toggle:</b> Implement
two simple scene presets (say �Bright� and �Dark�) with a UI toggle for GM. For
now, they can just change </span></span></span></span>Lighting.ambient_intensity and maybe the
background color. When you click the button, everyone should see the lighting
change. This will validate that Lighting.apply() changes propagate to
clients (be sure to test with another client, as earlier versions had host-only
issues<a href="https://tabletopsimulator.nolt.io/1165#:~:text=I%E2%80%99m%20trying%20to%20programatically%20change,to%20change%20the%20lighting%20with">[199]</a><span><span><span><span> � if
it fails, you might need a workaround like spawn light objects instead). 3. <b>Basic
Dice Pool Roll with Hunger:</b> Create a UI for players to roll a full pool
(combining the test from step 7 above). For instance, have two number inputs
(could be buttons or a slider) for pool and hunger, and a Roll button. Or even
simpler, make the Roll button roll with whatever the current hunger stat is and
a fixed test pool for now (like always 5 dice for initial test). When players
press Roll, output the result nicely in chat to all. This feature will hit many
parts: reading player�s hunger from state, performing calculation, formatting a
message. If this works, you know your communication and game logic framework is
solid.</span></span></span></span></p>

<p>Testing these
features thoroughly is important: try save/load around
them (e.g., set hunger to 3, save game, load game, ensure hunger persists via
your onSave/onLoad logic), try with multiple players (does each see only their
UI? Does the GM see all where appropriate?), and try edge cases (rolling with 0
dice, rouse with hunger 5 already, etc.).</p>

<h3><a name="common-pitfalls-troubleshooting"></a></h3>

<p><span><span><span><span>Be mindful of these TTS-specific quirks
and general issues: - <b>UI
Callback not firing:</b> If a UI button does nothing, check that the function
name in onClick exactly matches a global function (case-sensitive) and that the
XML id is correct. Also ensure the player�s color has permission (players can
always click their UI, but if something is GM-only UI and a player tries to
click it, nothing happens). Use </span></span></span></span>print() or
<span><span><span>log()<span> at start of the function to confirm
it runs. - <b>Scope of </b></span></span></span><span><span><code><b>self</b></span><b> in
coroutine:</b> If you copy </span></span></span>U.waitUntil and similar,
remember that inside Global context,
self refers to Global. If a coroutine isn�t
starting, maybe you used startLuaCoroutine(self,
...) inside a function that isn�t in an object. In
Global, that should still work (self=Global). If not, you can explicitly do
<span><span><span>startLuaCoroutine(Global,
...)<span>. - <b>Missing require in object scripts:</b>
If you find an object script can�t use </span></span></span></span>U or
S defined in global, that�s expected. Only
Global and that object�s namespace are shared (they share global environment in
TTS actually, but requires might not populate for object context). You might
have to require the util in object script too (the external editor might allow
it since all files might compile into one environment). If functions like
<span><span><span>Global.call(&quot;someFunction&quot;)<span> aren�t working, ensure the function is indeed global (e.g., defined
without local in global script or explicitly attached to Global). - <b>Networking
delays:</b> TTS is P2P; sometimes state changes (like lighting, object
movements) take a moment to sync. Using </span></span></span></span>Wait.time to stagger
actions can avoid race conditions, e.g., if you set a
light�s position and immediately its intensity, maybe do a tiny wait. The
repo�s throttle for zones<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L23-L31">[146]</a><span><span><span><span> is an
example to avoid too rapid triggers. If you find an event firing multiple times
(like onObjectDrop might fire as object settles), implement a throttle or check
a condition. - <b>Save/Load pitfalls:</b> Only simple data types can be
JSON-encoded for save. Functions or userdata in gameState will not encode. If
you accidentally store a player Object in gameState, JSON.encode will throw an
error. Use </span></span></span><span><span>log(JSON.encode_pretty(gameState))<span> in
onSave during testing to inspect what you�re saving. Remove any extraneous
stuff (like references to objects � instead save their GUIDs or names). - <b>Permission
issues:</b> If players can�t interact with something, check TTS�s options:
e.g., by default, Global script can do most things. But if you spawn objects,
make sure they aren�t spawning as GM-only. For example, if you spawn a token
for a handout and players can�t pick it up, maybe its </span></span></span><span><span>interactable<span> is off or
it�s in a zone they can�t reach. Also, if you lock an object
for narrative (like freeze NPC mini), players can�t move it (which may be
fine). - <b>Too many lights or objects causing lag:</b> The KD module faced
latency � likely due to many lights and continuous sequences. If you experience
slowdown, consider reducing effect frequency (e.g., do not update UI every
frame, only when needed; heavy use of coroutines is fine but hundreds might bog
down on clients). If you spawn many objects (like throwing 10 physical dice
each roll), network overhead and physics can lag � that�s why a scripted
outcome approach is often better for dice results in RPG context. - <b>Resilience
to resets:</b> TTS players might press the game reset button or rewind. Ensure
your onLoad handles re-initialization properly (the modules did by resetting
state and UI fully each time). Also ensure no leftover state persists weirdly
(TTS doesn�t truly multi-run the script � it reloads fresh on reset, so likely
fine). - <b>Naming collisions:</b> Avoid using global variable names that TTS
might use or that could conflict with other mods if combined. For instance,
naming your util table </span></span></span></span>U is fine as long as no
other mod�s global script is loaded (in a single
mod game it�s fine). Just keep everything under a namespace or clearly unique
(like prefix your functions with something if worried).</p>

<p>By following the
above plan and being mindful of pitfalls, you�ll
incrementally build up a powerful VTM5E module. Start small, test often
(especially with a second client to mimic a player�s view), and use the
patterns from the repo as proven solutions to common problems. Good luck, and
may your Chronicle run smoothly with these tools!<a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L26-L34">[1]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L48-L56">[7]</a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L254-L263">[16]</a></p>

<div align=center style='text-align:center'><span>

<hr size=2 width="100%" align=center>

</span></div>

<p><a name="citations"></a><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L26-L34">[1]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L23-L31">[3]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L35-L41">[6]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua#L26-L30">[208]</a> kingsdilemma.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma.ttslua</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L1-L9">[2]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L44-L52">[57]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L10-L18">[58]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L13-L21">[59]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L22-L30">[60]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L33-L41">[61]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L50-L53">[62]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L16-L25">[63]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L79-L87">[64]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L88-L93">[65]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L70-L78">[85]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L115-L124">[88]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L122-L129">[89]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L250-L259">[92]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L87-L93">[102]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L62-L70">[130]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L152-L160">[131]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L44-L47">[139]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L260-L269">[145]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L146-L149">[147]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L270-L275">[153]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L266-L274">[154]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L272-L280">[155]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L276-L284">[156]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L280-L288">[157]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L281-L285">[158]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua#L2-L9">[209]</a> heritage.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/heritage.ttslua</a></p>

<p><a href="https://api.tabletopsimulator.com/lighting/#:~:text=Lighting%2C%20a%20static%20global%20class%2C,Lighting.apply">[4]</a> <a href="https://api.tabletopsimulator.com/lighting/#:~:text=Lighting.light_intensity%20%3D%202%20Lighting.setLightColor%28,Lighting.apply">[5]</a> <a href="https://api.tabletopsimulator.com/lighting/#:~:text=Variable%20Type%20Description%20ambient_intensity%20The,Range">[190]</a> <a href="https://api.tabletopsimulator.com/lighting/#:~:text=Range%20%3D%200%20to%204,Range%20%3D%200%20to%201">[191]</a> <a href="https://api.tabletopsimulator.com/lighting/#:~:text=Function%20Name%20Return%20Description%20apply">[192]</a> <a href="https://api.tabletopsimulator.com/lighting/#:~:text=,Spawnable%20Objects%20%20Spawnable%20Objects">[198]</a> Lighting - Tabletop Simulator API</p>

<p><a href="https://api.tabletopsimulator.com/lighting/">https://api.tabletopsimulator.com/lighting/</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L48-L56">[7]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L52-L55">[8]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L64-L67">[9]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L69-L77">[10]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L78-L86">[11]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L100-L108">[12]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L109-L117">[13]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L2-L10">[14]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L115-L123">[15]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L114-L121">[48]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L156-L164">[53]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L119-L128">[136]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L152-L160">[137]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L176-L184">[138]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L110-L118">[164]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L153-L161">[181]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L167-L169">[182]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L120-L128">[183]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L103-L111">[214]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L29-L37">[244]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua#L101-L109">[256]</a> listeners.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/listeners.ttslua</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L254-L263">[16]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L262-L270">[17]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L316-L324">[18]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L327-L336">[19]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L181-L190">[20]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L192-L200">[21]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L163-L172">[22]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L2-L10">[23]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L256-L265">[24]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L280-L289">[25]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L186-L194">[28]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L110-L114">[44]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L264-L271">[45]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L260-L268">[46]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L272-L280">[47]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L282-L290">[49]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L296-L304">[50]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L78-L86">[51]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L90-L98">[52]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L208-L216">[54]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L240-L248">[56]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L260-L263">[159]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L36-L44">[160]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L54-L62">[161]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L38-L46">[162]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L76-L84">[167]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L327-L335">[168]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L38-L46">[170]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L80-L88">[172]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L256-L264">[173]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L328-L336">[174]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L182-L190">[179]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L194-L200">[180]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L194-L201">[184]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L206-L214">[218]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L184-L192">[241]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L190-L198">[242]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua#L163-L171">[243]</a> hud.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/hud.ttslua</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L23-L31">[26]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L46-L54">[27]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L24-L32">[135]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml#L32-L40">[252]</a> admin.xml</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/kdxml/admin.xml</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L644-L651">[29]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L10-L18">[30]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L22-L31">[31]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L676-L684">[32]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L686-L695">[33]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L682-L690">[34]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L691-L700">[35]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L722-L730">[36]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L734-L742">[37]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L540-L549">[38]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L551-L559">[39]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L559-L567">[40]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L619-L628">[41]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L715-L720">[42]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L643-L651">[43]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L50-L59">[55]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L648-L656">[93]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L543-L550">[165]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L680-L688">[193]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L684-L692">[194]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L542-L550">[195]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L60-L68">[196]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L694-L701">[197]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L540-L548">[201]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L47-L55">[202]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L58-L66">[203]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L607-L615">[212]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L723-L731">[213]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L654-L658">[216]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L690-L698">[239]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua#L624-L632">[247]</a> lighting.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/kingsdilemma/core/lighting.ttslua</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L302-L310">[66]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L311-L319">[67]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L316-L325">[68]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L332-L340">[69]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L350-L359">[70]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L144-L153">[71]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L156-L161">[72]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L79-L87">[73]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L89-L95">[74]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L354-L362">[75]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L372-L380">[76]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L370-L378">[77]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L376-L384">[78]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L384-L393">[79]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L389-L398">[80]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L413-L421">[81]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L430-L433">[82]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L440-L448">[83]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L444-L452">[84]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L120-L129">[86]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L136-L144">[87]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L1-L9">[90]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L350-L358">[91]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L66-L74">[128]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L146-L154">[132]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L324-L331">[134]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L80-L84">[140]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L420-L428">[166]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L108-L116">[185]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L36-L44">[186]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L37-L45">[187]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L13-L21">[188]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L26-L34">[189]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua#L180-L181">[206]</a> main.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/main.ttslua</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L86-L95">[94]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L43-L50">[95]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L48-L56">[96]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L67-L76">[97]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L80-L88">[98]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L57-L65">[99]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L130-L138">[100]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L145-L154">[101]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L114-L122">[103]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L123-L131">[104]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L2-L9">[105]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L34-L41">[106]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L70-L78">[107]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L116-L125">[108]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L115-L123">[109]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L36-L41">[133]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L23-L31">[146]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L122-L130">[163]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L104-L111">[248]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L160-L168">[249]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L164-L170">[250]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua#L121-L129">[251]</a> zones.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/zones.ttslua</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L69-L78">[110]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L69-L77">[111]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L70-L78">[112]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L22-L31">[113]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L50-L59">[114]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L52-L60">[115]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L74-L78">[116]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L88-L97">[117]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L92-L101">[118]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L100-L108">[119]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L150-L159">[120]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L160-L169">[121]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L170-L176">[122]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L134-L143">[123]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L140-L148">[124]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L72-L78">[125]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L172-L176">[126]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L174-L176">[127]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua#L80-L88">[205]</a> fourthRow.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/core/fourthRow.ttslua</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L72-L80">[129]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L66-L75">[141]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L92-L101">[142]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L74-L82">[143]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L146-L154">[144]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L66-L74">[148]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L158-L166">[149]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L170-L176">[150]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L48-L56">[151]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L4-L11">[152]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L73-L81">[177]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L144-L151">[178]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L144-L152">[207]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L32-L40">[253]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L132-L140">[254]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml#L134-L142">[255]</a> hud.xml</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/VTMH/xml/hud.xml</a></p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1006-L1014">[169]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1008-L1016">[171]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1000-L1009">[175]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1010-L1018">[176]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L914-L922">[210]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L915-L919">[211]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L906-L915">[215]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1056-L1064">[217]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L896-L905">[219]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L927-L935">[220]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L929-L938">[221]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L956-L961">[222]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L908-L916">[223]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L912-L919">[224]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L961-L969">[225]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L970-L978">[226]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L995-L1003">[227]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1004-L1012">[228]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1026-L1034">[229]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1035-L1043">[230]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1044-L1053">[231]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1066-L1074">[232]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1092-L1100">[233]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1094-L1102">[234]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1098-L1105">[235]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1074-L1082">[236]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1080-L1089">[237]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L1108-L1114">[238]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L913-L921">[240]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L932-L940">[245]</a> <a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua#L934-L939">[246]</a> utilities.ttslua</p>

<p><a href="https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua">https://github.com/Eunomiac/VtmHforTTS/blob/e5d61d4dcf656a654bdcf31bc6b2452344d94385/lib/utilities.ttslua</a></p>

<p><a href="https://tabletopsimulator.nolt.io/1165#:~:text=I%E2%80%99m%20trying%20to%20programatically%20change,to%20change%20the%20lighting%20with">[199]</a> <a href="https://tabletopsimulator.nolt.io/1165#:~:text=changes%20for%20all%20the%20players,to%20change%20the%20lighting%20with">[200]</a> Lighting class only changes the
Lighting setting for the host (and not the clients) � Tabletop Simulator
Feedback</p>

<p><a href="https://tabletopsimulator.nolt.io/1165">https://tabletopsimulator.nolt.io/1165</a>
</p>

<p><a href="https://api.tabletopsimulator.com/notes/#:~:text=Tabletop%20Simulator%20API,This%20appears%20in">[204]</a> Notes - Tabletop Simulator API</p>

<p><a href="https://api.tabletopsimulator.com/notes/">https://api.tabletopsimulator.com/notes/</a></p>

</body>

</html>